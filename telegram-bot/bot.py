import asyncio
import base64
import hashlib
import io
import logging
import os
import random
import re
import signal
from datetime import datetime, timezone

# ‚îÄ‚îÄ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: —Ç–æ–ª—å–∫–æ 1 —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
import subprocess as _sp

_PID_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), "bot.pid")

def _kill_old_instance() -> None:
    my_pid = os.getpid()
    # 1) –ü–æ PID-—Ñ–∞–π–ª—É
    if os.path.exists(_PID_FILE):
        try:
            old_pid = int(open(_PID_FILE).read().strip())
            if old_pid != my_pid:
                os.kill(old_pid, signal.SIGKILL)
        except (ValueError, ProcessLookupError, PermissionError, OSError):
            pass
    # 2) –ü–æ –∏–º–µ–Ω–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ ‚Äî —É–±–∏—Ç—å –≤—Å–µ ¬´python ‚Ä¶ bot.py¬ª, –∫—Ä–æ–º–µ —Å–µ–±—è
    try:
        out = _sp.check_output(["pgrep", "-f", "python.*bot\\.py"], text=True)
        for line in out.strip().splitlines():
            pid = int(line.strip())
            if pid != my_pid:
                try:
                    os.kill(pid, signal.SIGKILL)
                except (ProcessLookupError, PermissionError, OSError):
                    pass
    except (FileNotFoundError, _sp.CalledProcessError):
        pass
    with open(_PID_FILE, "w") as f:
        f.write(str(my_pid))

_kill_old_instance()
from typing import Optional, Dict, List, Any, Tuple
from dotenv import load_dotenv
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
from openai import OpenAI

# –ë—É—Ñ–µ—Ä —Ñ–æ—Ç–æ –ø–æ user_id –¥–ª—è —Ä–∞–∑–æ–≤–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ (–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ job)
_pending: Dict[int, Dict[str, Any]] = {}  # user_id -> {"chat_id": int, "file_ids": [(file_id, mime), ...]}
# –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ user_id –¥–ª—è –∫–Ω–æ–ø–æ–∫ ¬´–î–∏–∞–≥–Ω–æ–∑¬ª –∏ ¬´–õ–µ—á–µ–Ω–∏–µ¬ª
_user_last: Dict[int, Dict[str, str]] = {}  # user_id -> {"diagnosis": str, "treatment": str}
# –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –±–∞—Ç—á–∞, –∫–æ–≥–¥–∞ job_queue –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: user_id -> asyncio.Task
_pending_tasks: Dict[int, asyncio.Task] = {}

# Callback data –¥–ª—è –≤—ã–±–æ—Ä–∞ –ò–ò
CB_GROQ = "ai:groq"
CB_OPENAI = "ai:openai"
# –ü–æ—Ç–æ–∫ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: –ù–∞—á–∞—Ç—å -> —Å–æ–≥–ª–∞—Å–∏–µ -> –æ–ø—Ä–æ—Å–Ω–∏–∫
CB_FLOW_START = "flow:start"
CB_CONSENT_ACCEPT = "consent:accept"
CB_CONSENT_DECLINE = "consent:decline"
# –ü–æ—Å–ª–µ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞: –æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã
CB_NEXT_SURVEY = "next:survey"
CB_NEXT_UPLOAD = "next:upload"
# –û–ø—Ä–æ—Å: –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç¬ª
CB_SURVEY_SEND = "survey:send"
# –ü–æ—Ç–æ–∫ –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–∞: –∑–∞–ø—Ä–æ—Å ‚Üí –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Üí –∞–Ω–∞–ª–∏–∑
CB_SEND_DOCS = "docs:send"
CB_SHOW_RESULTS = "results:show"
CB_CONTINUE_YES = "continue:yes"
CB_CONTINUE_NO = "continue:no"
# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
CB_AUTH_LOGIN = "auth:login"
CB_AUTH_REGISTER = "auth:register"
CB_FORGOT_PASSWORD = "auth:forgot"

USERS_SHEET_HEADER = ["id", "email", "password", "password_hash", "telegram_id", "telegram_username", "confirmed", "created_at"]

# –ï–¥–∏–Ω—ã–π –±–ª–æ–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è (–†–§) ‚Äî –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–Ω–æ–ø–∫–∞ ¬´–°–æ–≥–ª–∞—Å–µ–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª
CONSENT_TEXT = """üìÑ <b>–ï–¥–∏–Ω—ã–π –±–ª–æ–∫ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è (–†–§)</b>
–ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É ¬´–°–æ–≥–ª–∞—Å–µ–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å¬ª, —è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ:

‚Ä¢ –ù–∞—Å—Ç–æ—è—â–∏–π —Å–µ—Ä–≤–∏—Å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π, –Ω–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ –æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –≤ —Å–º—ã—Å–ª–µ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ ‚Ññ 323-–§–ó ¬´–û–± –æ—Å–Ω–æ–≤–∞—Ö –æ—Ö—Ä–∞–Ω—ã –∑–¥–æ—Ä–æ–≤—å—è –≥—Ä–∞–∂–¥–∞–Ω –≤ –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏¬ª.

‚Ä¢ –ë–æ—Ç –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∏–∞–≥–Ω–æ–∑, –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –ª–µ—á–µ–Ω–∏–µ –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º.

‚Ä¢ –Ø –æ—Å–æ–∑–Ω–∞—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –≤—Ä–∞—á—É –∏–ª–∏ –≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è.

‚Ä¢ –í —Å–ª—É—á–∞–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏–º–ø—Ç–æ–º–æ–≤ (—É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏, –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–π –±–æ–ª–µ–≤–æ–π —Å–∏–Ω–¥—Ä–æ–º, –ø–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è, –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–Ω—Å—É–ª—å—Ç–∞ –∏–ª–∏ –∏–Ω—Ñ–∞—Ä–∫—Ç–∞ –∏ –¥—Ä.) —è –æ–±—è–∑–∞–Ω(–∞) –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –ø–æ–º–æ—â—å—é –∏–ª–∏ –≤—ã–∑–≤–∞—Ç—å —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å.

‚Ä¢ –Ø –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –≤–∫–ª—é—á–∞—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å–≤–µ–¥–µ–Ω–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è), –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º –∑–∞–∫–æ–Ω–æ–º ‚Ññ 152-–§–ó ¬´–û –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö¬ª, –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ü–µ–ª—è—Ö –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞.

‚Ä¢ –Ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–æ—ë–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è –∏ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –æ –ª–µ—á–µ–Ω–∏–∏ –ª–µ–∂–∏—Ç –Ω–∞ –º–Ω–µ –∏/–∏–ª–∏ –º–æ–µ–º –ª–µ—á–∞—â–µ–º –≤—Ä–∞—á–µ."""

# –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫ ‚Äî –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ (46 –≤–æ–ø—Ä–æ—Å–æ–≤), –ø–æ–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–µ 5
MEDICAL_QUESTIONS_FULL = [
    ("–§–∞–º–∏–ª–∏—è, –∏–º—è, –æ—Ç—á–µ—Å—Ç–≤–æ", None),
    ("–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1955)", None),
    ("–ü–æ–ª", "–º—É–∂—Å–∫–æ–π / –∂–µ–Ω—Å–∫–∏–π"),
    ("–†–æ—Å—Ç (—Å–º)", None),
    ("–í–µ—Å (–∫–≥)", None),
    ("–°–æ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å", "–ø—Ä–æ–∂–∏–≤–∞–µ—Ç –æ–¥–∏–Ω / —Å —Å–µ–º—å—ë–π / –≤ —É—á—Ä–µ–∂–¥–µ–Ω–∏–∏ —É—Ö–æ–¥–∞"),
    ("–û—Å–Ω–æ–≤–Ω–∞—è –∂–∞–ª–æ–±–∞", "–±–æ–ª—å / —Å–ª–∞–±–æ—Å—Ç—å / –æ–¥—ã—à–∫–∞ / –ø–æ–≤—ã—à–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã / –ø–∞–¥–µ–Ω–∏–µ / –¥—Ä—É–≥–æ–µ"),
    ("–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–ª–∏", "–≥—Ä—É–¥–Ω–∞—è –∫–ª–µ—Ç–∫–∞ / –∂–∏–≤–æ—Ç / –≥–æ–ª–æ–≤–∞ / –ø–æ—è—Å–Ω–∏—Ü–∞ / —Å—É—Å—Ç–∞–≤—ã / –∏–Ω–æ–µ"),
    ("–•–∞—Ä–∞–∫—Ç–µ—Ä –±–æ–ª–∏", "–æ—Å—Ç—Ä–∞—è / –Ω–æ—é—â–∞—è / –¥–∞–≤—è—â–∞—è / –∫–æ–ª—é—â–∞—è / –ø—Ä–∏—Å—Ç—É–ø–æ–æ–±—Ä–∞–∑–Ω–∞—è"),
    ("–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –±–æ–ª–∏", "—Å–ª–∞–±–∞—è / —É–º–µ—Ä–µ–Ω–Ω–∞—è / –≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è / –Ω–µ—Å—Ç–µ—Ä–ø–∏–º–∞—è"),
    ("–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–º–ø—Ç–æ–º–æ–≤", "—Å–µ–≥–æ–¥–Ω—è / 1‚Äì3 –¥–Ω—è / –±–æ–ª–µ–µ –Ω–µ–¥–µ–ª–∏"),
    ("–î–∏–Ω–∞–º–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è", "—É–ª—É—á—à–µ–Ω–∏–µ / –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π / —É—Ö—É–¥—à–µ–Ω–∏–µ"),
    ("–°–≤—è–∑–∞–Ω–æ –ª–∏ —É—Ö—É–¥—à–µ–Ω–∏–µ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ü—Ä–µ–¥—à–µ—Å—Ç–≤–æ–≤–∞–ª –ª–∏ —Å—Ç—Ä–µ—Å—Å?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ë—ã–ª–∏ –ª–∏ –ø–æ–¥–æ–±–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã —Ä–∞–Ω–µ–µ?", "–¥–∞ / –Ω–µ—Ç"),
    ("–í—ã–∑—ã–≤–∞–ª–∞—Å—å –ª–∏ —Å–∫–æ—Ä–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò—à–µ–º–∏—á–µ—Å–∫–∞—è –±–æ–ª–µ–∑–Ω—å —Å–µ—Ä–¥—Ü–∞?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò–Ω—Ñ–∞—Ä–∫—Ç –º–∏–æ–∫–∞—Ä–¥–∞ –≤ –∞–Ω–∞–º–Ω–µ–∑–µ?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò–Ω—Å—É–ª—å—Ç –≤ –∞–Ω–∞–º–Ω–µ–∑–µ?", "–¥–∞ / –Ω–µ—Ç"),
    ("–°–∞—Ö–∞—Ä–Ω—ã–π –¥–∏–∞–±–µ—Ç?", "–¥–∞ / –Ω–µ—Ç"),
    ("–•—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è –±–æ–ª–µ–∑–Ω—å –ø–æ—á–µ–∫?", "–¥–∞ / –Ω–µ—Ç"),
    ("–•–û–ë–õ / –±—Ä–æ–Ω—Ö–∏–∞–ª—å–Ω–∞—è –∞—Å—Ç–º–∞?", "–¥–∞ / –Ω–µ—Ç"),
    ("–û–Ω–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ü—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–∏ –≤—ã –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é —Ç–µ—Ä–∞–ø–∏—é?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ì–∏–ø–æ—Ç–µ–Ω–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ê–Ω—Ç–∏–∫–æ–∞–≥—É–ª—è–Ω—Ç—ã / –∞–Ω—Ç–∏–∞–≥—Ä–µ–≥–∞–Ω—Ç—ã?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò–Ω—Å—É–ª–∏–Ω / —Å–∞—Ö–∞—Ä–æ—Å–Ω–∏–∂–∞—é—â–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ü—Ä–∏–Ω—è—Ç—ã –ª–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã —Å–µ–≥–æ–¥–Ω—è?", "–¥–∞ / –Ω–µ—Ç / –ø—Ä–æ–ø—É—Å—Ç–∏–ª"),
    ("–ê—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", "<100 / 100‚Äì130 / 130‚Äì150 / 150‚Äì180 / >180"),
    ("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ª–∞", "–Ω–æ—Ä–º–∞ / –¥–æ 37.5 / 37.5‚Äì38.5 / >38.5"),
    ("–ß–∞—Å—Ç–æ—Ç–∞ –ø—É–ª—å—Å–∞", "<60 / 60‚Äì90 / >90 / –Ω–µ –∏–∑–º–µ—Ä—è–ª"),
    ("–ù–∞–ª–∏—á–∏–µ –æ—Ç—ë–∫–æ–≤?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ä–µ—á–∏?", "–¥–∞ / –Ω–µ—Ç"),
    ("–û–Ω–µ–º–µ–Ω–∏–µ –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ù–∞—Ä—É—à–µ–Ω–∏–µ –∑—Ä–µ–Ω–∏—è?", "–¥–∞ / –Ω–µ—Ç"),
    ("–°—É–¥–æ—Ä–æ–∂–Ω—ã–π —Å–∏–Ω–¥—Ä–æ–º?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ü–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è?", "–¥–∞ / –Ω–µ—Ç"),
    ("–§–∞–∫—Ç –ø–∞–¥–µ–Ω–∏—è?", "–¥–∞ / –Ω–µ—Ç"),
    ("–£–¥–∞—Ä –≥–æ–ª–æ–≤–æ–π?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ü–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ë–æ–ª—å –≤ –æ–±–ª–∞—Å—Ç–∏ —Ç–∞–∑–∞ –∏–ª–∏ —à–µ–π–∫–∏ –±–µ–¥—Ä–∞?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ù–∞–ª–∏—á–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –∞–ª–ª–µ—Ä–≥–∏–∏?", "–¥–∞ / –Ω–µ—Ç / –Ω–µ –∑–Ω–∞—é"),
    ("–ê–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò–º–µ—é—Ç—Å—è –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–æ–≤?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò–º–µ—é—Ç—Å—è –ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –≤—Ä–∞—á–µ–π?", "–¥–∞ / –Ω–µ—Ç"),
    ("–ò–º–µ—é—Ç—Å—è –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π (–£–ó–ò / –ö–¢ / –ú–†–¢)?", "–¥–∞ / –Ω–µ—Ç"),
    ("–û–±—â–µ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ", "—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ / —Å—Ä–µ–¥–Ω–µ–π —Ç—è–∂–µ—Å—Ç–∏ / —Ç—è–∂—ë–ª–æ–µ / –∫—Ä–∞–π–Ω–µ —Ç—è–∂—ë–ª–æ–µ"),
]
# –°–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–Ω—ã —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –≤–æ–ø—Ä–æ—Å–æ–≤ (–¥–ª—è —Ç–µ—Å—Ç–∞). –ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ 46: MEDICAL_QUESTIONS = MEDICAL_QUESTIONS_FULL
MEDICAL_QUESTIONS = MEDICAL_QUESTIONS_FULL[:5]


def _ai_choice_keyboard() -> Optional[InlineKeyboardMarkup]:
    """–ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ò–ò (—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã)."""
    buttons = []
    if _use_groq():
        buttons.append(InlineKeyboardButton("Groq", callback_data=CB_GROQ))
    if get_openai_client():
        buttons.append(InlineKeyboardButton("OpenAI (GPT)", callback_data=CB_OPENAI))
    if not buttons:
        return None
    return InlineKeyboardMarkup([buttons])


# –£–±–∏—Ä–∞–µ–º reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É ‚Äî –≤–º–µ—Å—Ç–æ –Ω–µ—ë –∏—Å–ø–æ–ª—å–∑—É–µ–º ReplyKeyboardRemove
MAIN_KEYBOARD = ReplyKeyboardRemove()
SURVEY_KEYBOARD = ReplyKeyboardRemove()

load_dotenv()

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# --- Google –¢–∞–±–ª–∏—Ü–∞ ---
# –ö–æ—Ä–æ—Ç–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–ø–æ—Ä—è–¥–æ–∫ = MEDICAL_QUESTIONS_FULL)
_Q_LABELS = [
    "—Ñ–∏–æ", "–≥–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è", "–ø–æ–ª", "—Ä–æ—Å—Ç", "–≤–µ—Å",
    "—Å–æ—Ü. —Å—Ç–∞—Ç—É—Å", "–∂–∞–ª–æ–±–∞", "–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–ª–∏", "—Ö–∞—Ä–∞–∫—Ç–µ—Ä –±–æ–ª–∏", "–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å",
    "–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–¥–∏–Ω–∞–º–∏–∫–∞", "–Ω–∞–≥—Ä—É–∑–∫–∞", "—Å—Ç—Ä–µ—Å—Å", "—Ä–∞–Ω–µ–µ",
    "—Å–∫–æ—Ä–∞—è", "–≥–∏–ø–µ—Ä—Ç–µ–Ω–∑–∏—è", "–ò–ë–°", "–∏–Ω—Ñ–∞—Ä–∫—Ç", "–∏–Ω—Å—É–ª—å—Ç",
    "–¥–∏–∞–±–µ—Ç", "–•–ë–ü", "–•–û–ë–õ/–∞—Å—Ç–º–∞", "–æ–Ω–∫–æ–ª–æ–≥–∏—è", "—Ç–µ—Ä–∞–ø–∏—è",
    "–≥–∏–ø–æ—Ç–µ–Ω–∑–∏–≤–Ω—ã–µ", "–∞–Ω—Ç–∏–∫–æ–∞–≥—É–ª—è–Ω—Ç—ã", "–∏–Ω—Å—É–ª–∏–Ω", "–ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤", "–ê–î",
    "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞", "–ø—É–ª—å—Å", "–æ—Ç—ë–∫–∏", "—Ä–µ—á—å", "–æ–Ω–µ–º–µ–Ω–∏–µ",
    "–∑—Ä–µ–Ω–∏–µ", "—Å—É–¥–æ—Ä–æ–≥–∏", "–ø–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è", "–ø–∞–¥–µ–Ω–∏–µ", "—É–¥–∞—Ä –≥–æ–ª–æ–≤–æ–π",
    "–ø–æ—Ç–µ—Ä—è —Å–æ–∑–Ω–∞–Ω–∏—è (–ø–∞–¥–µ–Ω–∏–µ)", "—Ç–∞–∑/—à–µ–π–∫–∞ –±–µ–¥—Ä–∞", "–∞–ª–ª–µ—Ä–≥–∏—è –ª–µ–∫.", "–∞–ª–ª–µ—Ä–≥–∏—è –ø–∏—â.", "–∞–Ω–∞–ª–∏–∑—ã",
    "–∑–∞–∫–ª—é—á–µ–Ω–∏—è", "–£–ó–ò/–ö–¢/–ú–†–¢", "—Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ",
]
# –ó–∞–≥–æ–ª–æ–≤–æ–∫: id | –¥–∞—Ç–∞ | <–Ω–∞–∑–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞>
SHEET_HEADER = ["id", "–¥–∞—Ç–∞", "telegram", "—Ç–µ–ª–µ—Ñ–æ–Ω"] + _Q_LABELS[:len(MEDICAL_QUESTIONS)]


_sheet_cache: Dict[str, Any] = {"wks": None, "ts": 0.0, "header_ok": False}
_SHEET_CACHE_TTL = 300  # 5 –º–∏–Ω—É—Ç

def _get_sheet_wks():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (worksheet, None) –∏–ª–∏ (None, –æ—à–∏–±–∫–∞). –ö–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç."""
    import time as _time
    now = _time.time()
    if _sheet_cache["wks"] is not None and (now - _sheet_cache["ts"]) < _SHEET_CACHE_TTL:
        return _sheet_cache["wks"], None

    sheet_id = os.getenv("GOOGLE_SHEET_ID")
    creds_path = os.getenv("GOOGLE_CREDENTIALS_JSON", "credentials.json")
    if not sheet_id or not sheet_id.strip():
        return None, None
    creds_path = (creds_path or "").strip()
    if not creds_path or not os.path.isfile(creds_path):
        logger.warning("Google credentials file not found: %s", creds_path)
        return None, "–§–∞–π–ª —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω."
    try:
        import gspread
        from google.oauth2.service_account import Credentials
    except ImportError:
        return None, "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install gspread google-auth"
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_file(creds_path, scopes=scopes)
    gc = gspread.authorize(creds)
    sh = gc.open_by_key(sheet_id.strip())
    wks = sh.sheet1
    _sheet_cache["wks"] = wks
    _sheet_cache["ts"] = now
    _sheet_cache["header_ok"] = False
    return wks, None


def _sheet_start_row(tg_username: str = "", tg_phone: str = "") -> Tuple[Optional[int], Optional[int], Optional[str]]:
    """
    –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É (id + –¥–∞—Ç–∞ + telegram + —Ç–µ–ª–µ—Ñ–æ–Ω) –≤ –Ω–∞—á–∞–ª–µ –æ–ø—Ä–æ—Å–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (row_index_1based, id, None) –∏–ª–∏ (None, None, –æ—à–∏–±–∫–∞).
    """
    try:
        wks, err = _get_sheet_wks()
        if wks is None:
            return None, None, err
        rows = wks.get_all_values()

        expected_header = SHEET_HEADER
        if not rows:
            wks.append_row(expected_header, value_input_option="RAW")
            rows = [expected_header]
        elif not _sheet_cache.get("header_ok"):
            current_header = rows[0][:len(expected_header)]
            if current_header != expected_header:
                cell_range = f"A1:{chr(64 + len(expected_header))}1"
                wks.update(cell_range, [expected_header], value_input_option="RAW")
            _sheet_cache["header_ok"] = True

        new_id = 1
        for i, row in enumerate(rows):
            if i == 0:
                continue
            if row and row[0]:
                try:
                    existing_id = int(row[0])
                    if existing_id >= new_id:
                        new_id = existing_id + 1
                except (ValueError, TypeError):
                    pass

        now = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
        new_row = [str(new_id), now, tg_username or "", tg_phone or ""] + [""] * len(MEDICAL_QUESTIONS)
        wks.append_row(new_row, value_input_option="RAW")
        row_index = len(rows) + 1
        return row_index, new_id, None
    except Exception as e:
        _sheet_cache["wks"] = None
        logger.exception("Google Sheet start row error: %s", e)
        return None, None, str(e)[:200]


def _sheet_update_answer(row_index: int, step: int, value: str) -> Optional[str]:
    """
    –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å step (1-based) –≤ —Å—Ç—Ä–æ–∫—É row_index.
    –°—Ç–æ–ª–±–µ—Ü: A=id, B=–¥–∞—Ç–∞, C=telegram, D=—Ç–µ–ª–µ—Ñ–æ–Ω, E=q1(step1), F=q2(step2), ‚Ä¶
    """
    try:
        wks, err = _get_sheet_wks()
        if wks is None:
            return err
        col = step + 4  # step 1 ‚Üí col 5 (E), step 2 ‚Üí col 6 (F), ...
        cell_value = (value or "")[:500]
        wks.update_cell(row_index, col, cell_value)
        return None
    except Exception as e:
        _sheet_cache["wks"] = None
        logger.exception("Google Sheet update cell error: %s", e)
        return str(e)[:200]


# --------------- –õ–∏—Å—Ç users (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è) ---------------

_users_cache: Dict[str, Any] = {"wks": None, "ts": 0.0}

def _get_users_wks():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (worksheet 'users', None) –∏–ª–∏ (None, –æ—à–∏–±–∫–∞). –ö–µ—à–∏—Ä—É–µ—Ç—Å—è."""
    import time as _time
    now = _time.time()
    if _users_cache["wks"] is not None and (now - _users_cache["ts"]) < _SHEET_CACHE_TTL:
        return _users_cache["wks"], None

    sheet_id = os.getenv("GOOGLE_SHEET_ID")
    creds_path = os.getenv("GOOGLE_CREDENTIALS_JSON", "credentials.json")
    if not sheet_id or not sheet_id.strip():
        return None, None
    creds_path = (creds_path or "").strip()
    if not creds_path or not os.path.isfile(creds_path):
        return None, "–§–∞–π–ª —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω."
    try:
        import gspread
        from google.oauth2.service_account import Credentials
    except ImportError:
        return None, "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install gspread google-auth"
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_file(creds_path, scopes=scopes)
    gc = gspread.authorize(creds)
    sh = gc.open_by_key(sheet_id.strip())
    try:
        wks = sh.worksheet("users")
    except Exception:
        wks = sh.add_worksheet(title="users", rows=1000, cols=len(USERS_SHEET_HEADER))
        wks.append_row(USERS_SHEET_HEADER, value_input_option="RAW")
    try:
        wks.freeze(rows=1)
    except Exception:
        pass
    first_row = wks.row_values(1)
    if first_row != USERS_SHEET_HEADER:
        wks.update("A1:H1", [USERS_SHEET_HEADER], value_input_option="RAW")
        wks.freeze(rows=1)
    _users_cache["wks"] = wks
    _users_cache["ts"] = now
    return wks, None


def _hash_password(password: str) -> str:
    return hashlib.sha256(password.encode("utf-8")).hexdigest()


def _find_user_by_email(email: str) -> Optional[Dict[str, str]]:
    """–ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict –∏–ª–∏ None."""
    try:
        wks, err = _get_users_wks()
        if wks is None:
            return None
        rows = wks.get_all_values()
        email_lower = email.strip().lower()
        for i, row in enumerate(rows):
            if i == 0:
                continue
            if len(row) > 1 and row[1].strip().lower() == email_lower:
                return {
                    "row_index": i + 1,
                    "id": row[0] if len(row) > 0 else "",
                    "email": row[1] if len(row) > 1 else "",
                    "password": row[2] if len(row) > 2 else "",
                    "password_hash": row[3] if len(row) > 3 else "",
                    "telegram_id": row[4] if len(row) > 4 else "",
                    "telegram_username": row[5] if len(row) > 5 else "",
                    "confirmed": row[6] if len(row) > 6 else "",
                    "created_at": row[7] if len(row) > 7 else "",
                }
        return None
    except Exception as e:
        _users_cache["wks"] = None
        logger.exception("find_user_by_email error: %s", e)
        return None


def _next_user_id(wks) -> int:
    """–í—ã—á–∏—Å–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (max —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö + 1)."""
    try:
        rows = wks.get_all_values()
        max_id = 0
        for i, row in enumerate(rows):
            if i == 0 or not row:
                continue
            try:
                max_id = max(max_id, int(row[0]))
            except (ValueError, IndexError):
                pass
        return max_id + 1
    except Exception:
        return 1


def _create_user(email: str, password: str, tg_id: int, tg_username: str) -> Optional[str]:
    """–°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (confirmed=no). –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, –∏–Ω–∞—á–µ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏."""
    try:
        wks, err = _get_users_wks()
        if wks is None:
            return err or "–¢–∞–±–ª–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
        existing = _find_user_by_email(email)
        if existing:
            return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω."
        new_id = _next_user_id(wks)
        now = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")
        row = [str(new_id), email.strip().lower(), password, _hash_password(password), str(tg_id), tg_username, "no", now]
        wks.append_row(row, value_input_option="RAW")
        return None
    except Exception as e:
        _users_cache["wks"] = None
        logger.exception("create_user error: %s", e)
        return str(e)[:200]


def _confirm_user(email: str) -> bool:
    """–°—Ç–∞–≤–∏—Ç confirmed=yes. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –ø—Ä–∏ —É—Å–ø–µ—Ö–µ."""
    try:
        wks, err = _get_users_wks()
        if wks is None:
            return False
        rows = wks.get_all_values()
        email_lower = email.strip().lower()
        for i, row in enumerate(rows):
            if i == 0:
                continue
            if len(row) > 1 and row[1].strip().lower() == email_lower:
                wks.update_cell(i + 1, 7, "yes")
                return True
        return False
    except Exception as e:
        _users_cache["wks"] = None
        logger.exception("confirm_user error: %s", e)
        return False


def _check_password(email: str, password: str) -> Optional[Dict[str, str]]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None."""
    user = _find_user_by_email(email)
    if not user:
        return None
    if user.get("confirmed", "").lower() != "yes":
        return None
    if user.get("password_hash") == _hash_password(password):
        return user
    return None


def _update_user_tg(email: str, tg_id: int, tg_username: str) -> None:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç telegram_id –∏ username –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."""
    try:
        wks, err = _get_users_wks()
        if wks is None:
            return
        rows = wks.get_all_values()
        email_lower = email.strip().lower()
        for i, row in enumerate(rows):
            if i == 0:
                continue
            if len(row) > 1 and row[1].strip().lower() == email_lower:
                wks.update_cell(i + 1, 5, str(tg_id))
                wks.update_cell(i + 1, 6, tg_username)
                return
    except Exception as e:
        _users_cache["wks"] = None
        logger.exception("update_user_tg error: %s", e)


def _reset_user_password(email: str) -> Optional[str]:
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–∞—Ä–æ–ª—å: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ö–µ—à –≤ —Ç–∞–±–ª–∏—Ü—É. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ None."""
    try:
        wks, err = _get_users_wks()
        if wks is None:
            return None
        rows = wks.get_all_values()
        email_lower = email.strip().lower()
        for i, row in enumerate(rows):
            if i == 0:
                continue
            if len(row) > 1 and row[1].strip().lower() == email_lower:
                new_password = str(random.randint(100000, 999999))
                wks.update_cell(i + 1, 3, new_password)
                wks.update_cell(i + 1, 4, _hash_password(new_password))
                return new_password
        return None
    except Exception as e:
        _users_cache["wks"] = None
        logger.exception("reset_password error: %s", e)
        return None


# –ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
MEDICAL_PROMPT = """–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–∂–∏–ª—ã–º –ª—é–¥—è–º –ø–æ–Ω—è—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã: –∞–Ω–∞–ª–∏–∑—ã, –∑–∞–∫–ª—é—á–µ–Ω–∏—è –≤—Ä–∞—á–µ–π, –≤—ã–ø–∏—Å–∫–∏ –∏–∑ –±–æ–ª—å–Ω–∏—Ü—ã.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ü—Ä–æ—á–∏—Ç–∞–π –∏ —Ä–∞–∑–±–µ—Ä–∏ –≤—Å—ë, —á—Ç–æ –≤–∏–¥–∏—à—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ (—Ç–µ–∫—Å—Ç, —Ü–∏—Ñ—Ä—ã, –ø–µ—á–∞—Ç–∏).
2. –û–±—ä—è—Å–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ü–†–û–°–¢–´–ú–ò —Å–ª–æ–≤–∞–º–∏, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ (–∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—è—Å–Ω—è–π –∏—Ö).
3. –°–∫–∞–∂–∏, —á—Ç–æ –≤ –Ω–æ—Ä–º–µ, –∞ –Ω–∞ —á—Ç–æ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ.
4. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è ‚Äî –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –æ–Ω–∏ –º–æ–≥—É—Ç –∑–Ω–∞—á–∏—Ç—å –∏ –Ω—É–∂–Ω–æ –ª–∏ —Å—Ä–æ—á–Ω–æ –∫ –≤—Ä–∞—á—É.
5. –í –∫–æ–Ω—Ü–µ –∫—Ä–∞—Ç–∫–æ —Ä–µ–∑—é–º–∏—Ä—É–π: –≤—Å—ë –ª–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ.

–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ. –ù–µ –ø—É–≥–∞–π, –Ω–æ –∏ –Ω–µ —Å–∫—Ä—ã–≤–∞–π –≤–∞–∂–Ω–æ–µ."""

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: –æ–¥–∏–Ω –æ–±—â–∏–π —Ä–∞–∑–±–æ—Ä, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è, –≤—ã–≤–æ–¥—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
MULTI_DOC_PROMPT = """–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–∂–∏–ª—ã–º –ª—é–¥—è–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —Å—Ä–∞–∑—É: –∞–Ω–∞–ª–∏–∑—ã, –∑–∞–∫–ª—é—á–µ–Ω–∏—è, –≤—ã–ø–∏—Å–∫–∏.

–ü–æ –≤—Å–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤–º–µ—Å—Ç–µ —Å–¥–µ–ª–∞–π –û–î–ù–û –∫–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ. –£–ª–æ–∂–∏ –≤ –î–í–ê —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–±–∑–∞—Ü–∞ (–Ω—É–º–µ—Ä—É–π –ø—É–Ω–∫—Ç—ã 1-2-3). –ü–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏ —á—ë—Ç–∫–æ.

–ê–ë–ó–ê–¶ 1 ‚Äî –ß–¢–û –ü–†–û–ò–ó–û–®–õ–û –ò –ß–¢–û –≠–¢–û –ó–ù–ê–ß–ò–¢:
1) –ö—Ä–∞—Ç–∫–æ: —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ –∑–¥–æ—Ä–æ–≤—å–µ–º (—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è, —Å–≤—è–∑–∫–∏ –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏).
2) –ö–∞–∫–∏–µ —Ü–∏—Ñ—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤/–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π —ç—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç (–∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏).
3) –ß—Ç–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é—Ç –≤—Ä–∞—á–∏, —á—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ –∏ —á—Ç–æ –ø–ª–∞–Ω–∏—Ä—É—é—Ç —Å–¥–µ–ª–∞—Ç—å.

–ê–ë–ó–ê–¶ 2 ‚Äî –ß–¢–û –î–ï–õ–ê–¢–¨ –ò –ö –ß–ï–ú–£ –ë–´–¢–¨ –ì–û–¢–û–í–´–ú:
1) –ß–µ–≥–æ –≤—Ä–∞—á–∏ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –∏–ª–∏ –Ω–µ —É—á–ª–∏ ‚Äî —á—Ç–æ –≤–∞–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –Ω–∞ –ø—Ä–∏—ë–º–µ.
2) –ö–∞–∫ —Å–µ–±—è –≤–µ—Å—Ç–∏ –∏ –∫ —á–µ–º—É –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º (—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ, –±–µ–∑ –ø–∞–Ω–∏–∫–∏).
3) –ß—Ç–æ —Ç–æ—á–Ω–æ –¥–µ–ª–∞—Ç—å –∏ —á–µ–≥–æ —Ç–æ—á–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏).

–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏. –ù–µ –ø—É–≥–∞–π, –Ω–æ –Ω–µ —Å–∫—Ä—ã–≤–∞–π –≤–∞–∂–Ω–æ–µ. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π ‚Äî —Ç–æ–ª—å–∫–æ —Å—É—Ç—å –∏ –≤—ã–≤–æ–¥—ã."""

TEXT_PROMPT = """–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–∂–∏–ª—ã–º –ª—é–¥—è–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∑–¥–æ—Ä–æ–≤—å—è –∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–∞—Ö. –û—Ç–≤–µ—á–∞–π –ø—Ä–æ—Å—Ç—ã–º —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º, –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∞–Ω–∞–ª–∏–∑—ã –∏–ª–∏ –¥–∏–∞–≥–Ω–æ–∑—ã ‚Äî –æ–±—ä—è—Å–Ω–∏ –±–µ–∑ —Å—Ç—Ä–∞—à–Ω—ã—Ö —Å–ª–æ–≤ –∏ –ø–æ–¥—Å–∫–∞–∂–∏, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ."""

FOLLOWUP_PROMPT = """–¢—ã ‚Äî –≤—Ä–∞—á-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≤—ã—Å—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –¢—ã —É–∂–µ –ø—Ä–æ–≤—ë–ª –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞.

–î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê (–∏–∑ –æ–ø—Ä–æ—Å–∞):
{survey_data}

–ü–†–ï–î–´–î–£–©–ò–ô –ê–ù–ê–õ–ò–ó:
{previous_analysis}

–ù–û–í–´–ô –í–û–ü–†–û–° –ü–ê–¶–ò–ï–ù–¢–ê:
{followup_question}

–ó–ê–î–ê–ß–ê:
1. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
2. –ï—Å–ª–∏ –ø–∞—Ü–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –≤—Ä–∞—á–µ ‚Äî —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ –∫ –Ω–µ–º—É.
3. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–∞—Ö ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã, –∑–∞—á–µ–º –∫–∞–∂–¥—ã–π –Ω—É–∂–µ–Ω.
4. –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ —É–∫–∞–∂–∏, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –µ—â—ë –ø–æ–º–æ–≥–ª–∏ –±—ã —É—Ç–æ—á–Ω–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∏–µ).

–§–æ—Ä–º–∞—Ç:
- –°–Ω–∞—á–∞–ª–∞ –ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
- –ó–∞—Ç–µ–º –±–ª–æ–∫ ¬´–î–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –±—ã–ª–æ –±—ã –ø–æ–ª–µ–∑–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å:¬ª (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π LaTeX, $, \\text{}. –ß–∏—Å–ª–∞ –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (126 –≥/–ª, 10‚Åπ/–ª).
–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –æ–±—Ä–∞—â–∞—è—Å—å –Ω–∞ ¬´–≤—ã¬ª."""

REQUEST_ANALYSIS_PROMPT = """–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç –≤—ã—Å—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å 30-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. –¢–µ–±–µ –ø–æ—Å—Ç—É–ø–∏–ª –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞.

–î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê (–∏–∑ –æ–ø—Ä–æ—Å–∞):
{survey_data}

–ó–ê–ü–†–û–° –ü–ê–¶–ò–ï–ù–¢–ê:
{patient_request}
{followup_qa}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –û–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–æ–±–ª–µ–º—ã (–∫–∞—Ä–¥–∏–æ–ª–æ–≥–∏—è, –Ω–µ–≤—Ä–æ–ª–æ–≥–∏—è, —Ç–µ—Ä–∞–ø–∏—è, —Ö–∏—Ä—É—Ä–≥–∏—è, —ç–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–∏—è, –∏ —Ç.–¥.).
2. –ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞, –æ–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ù–ï–û–ë–•–û–î–ò–ú–´ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

–û—Ç–≤–µ—Ç—å –ö–†–ê–¢–ö–û –∏ –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–û. –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –æ–±—Ä–∞—â–∞—è—Å—å –∫ –ø–∞—Ü–∏–µ–Ω—Ç—É –Ω–∞ ¬´–≤—ã¬ª.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
1) –û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –≤—ã –ø–æ–Ω—è–ª–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞.
2) –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å (—Ç–æ–ª—å–∫–æ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞, –≤—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–µ):
- –ê–Ω–∞–ª–∏–∑—ã (–∫—Ä–æ–≤—å, –º–æ—á–∞, –±–∏–æ—Ö–∏–º–∏—è –∏ –¥—Ä.)
- –í—ã–ø–∏—Å–Ω–æ–π —ç–ø–∏–∫—Ä–∏–∑
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –≤—Ä–∞—á–∞
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ä–µ—Ü–µ–ø—Ç—ã
- –ü—Ä–æ—Ç–æ–∫–æ–ª –°–ú–ü (—Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏)
- –ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏ / –∞–º–±—É–ª–∞—Ç–æ—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π (–£–ó–ò, –ö–¢, –ú–†–¢, –≠–ö–ì, —Ä–µ–Ω—Ç–≥–µ–Ω)

–ù–µ –ø–∏—à–∏ –ª–∏—à–Ω–µ–≥–æ. –ù–µ —Å—Ç–∞–≤—å –¥–∏–∞–≥–Ω–æ–∑. –ù–µ –ø—É–≥–∞–π."""

# –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏ (1‚Äì5 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
CLARIFY_QUESTIONS_PROMPT = """–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç. –ü–∞—Ü–∏–µ–Ω—Ç –æ–ø–∏—Å–∞–ª —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç 1 –¥–æ 5 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —Ç–æ—á–Ω–µ–µ –ø–æ–Ω—è—Ç—å —Å–ª—É—á–∞–π –∏ –¥–∞—Ç—å –±–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

–î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê (–∏–∑ –æ–ø—Ä–æ—Å–∞):
{survey_data}

–û–ü–ò–°–ê–ù–ò–ï –°–ò–¢–£–ê–¶–ò–ò –û–¢ –ü–ê–¶–ò–ï–ù–¢–ê:
{patient_request}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–æ–ø—Ä–æ—Å–∞–º:
- –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏, –∫—Ä–∞—Ç–∫–∏–º–∏ –∏ –ø–æ –¥–µ–ª—É (—Å–∏–º–ø—Ç–æ–º—ã, —Å—Ä–æ–∫–∏, –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞, —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤ –∏ —Ç.–¥.).
- –ù–µ –∑–∞–¥–∞–≤–∞–π –±–æ–ª–µ–µ 5 –≤–æ–ø—Ä–æ—Å–æ–≤. –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 1‚Äì2 ‚Äî –∑–∞–¥–∞–π 1‚Äì2.
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Å—Ç—Ä–æ–≥–æ –ø–æ –æ–¥–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ü—Ä–∏–º–µ—Ä:
–ö–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ –ø–æ—è–≤–∏–ª–∞—Å—å –±–æ–ª—å?
–ü—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –ª–∏ –≤—ã –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–∏–µ –∏ –∫–∞–∫–∏–µ?
- –ù–µ –ø–∏—à–∏ –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑ —Ç–∏–ø–∞ ¬´–í–æ–ø—Ä–æ—Å—ã:¬ª ‚Äî —Ç–æ–ª—å–∫–æ —Å–∞–º–∏ –≤–æ–ø—Ä–æ—Å—ã, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.
- –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –Ω–∞ ¬´–≤—ã¬ª."""

# –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (1‚Äì5 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è)
POST_DOC_QUESTIONS_PROMPT = """–¢—ã ‚Äî –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç. –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É–∂–µ –ø—Ä–æ–≤–µ–¥—ë–Ω –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑. –ß—Ç–æ–±—ã —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É –æ—Ç 1 –¥–æ 5 –∫–æ—Ä–æ—Ç–∫–∏—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

–ó–ê–ü–†–û–° –ü–ê–¶–ò–ï–ù–¢–ê:
{patient_request}

–ü–ï–†–í–ò–ß–ù–´–ô –ê–ù–ê–õ–ò–ó (–∫—Ä–∞—Ç–∫–æ):
{analysis_summary}

–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ—Ç 1 –¥–æ 5 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –æ—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —Ç–µ–∫—É—â–∏–µ —Å–∏–º–ø—Ç–æ–º—ã, –ø—Ä–∏—ë–º –ª–µ–∫–∞—Ä—Å—Ç–≤, –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∞–ª–ª–µ—Ä–≥–∏–∏, —á—Ç–æ —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª –∏ —Ç.–¥.). –í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: —Å—Ç—Ä–æ–≥–æ –ø–æ –æ–¥–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏. –ù–µ –ø–∏—à–∏ –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑ ‚Äî —Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. –ü–æ-—Ä—É—Å—Å–∫–∏, –Ω–∞ ¬´–≤—ã¬ª."""

# –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º –æ—Ç–≤–µ—Ç–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
REFINED_ANALYSIS_PROMPT = """–¢—ã ‚Äî –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç. –£ —Ç–µ–±—è –µ—Å—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. –î–∞–π –∏—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —É—á—ë—Ç–æ–º —ç—Ç–æ–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–ü–ï–†–í–ò–ß–ù–´–ô –ê–ù–ê–õ–ò–ó:
{full_analysis}

–£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´ –ò –û–¢–í–ï–¢–´ –ü–ê–¶–ò–ï–ù–¢–ê:
{qa_block}

–ó–ê–î–ê–ß–ê: —Å–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ (—Ä–µ–∑—é–º–µ, –∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, –¥–∏–∞–≥–Ω–æ–∑, —á—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞, –¥–µ–π—Å—Ç–≤–∏—è –≤—Ä–∞—á–µ–π, –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π), –Ω–æ –¥–æ–ø–æ–ª–Ω–∏ –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π —Ä–∞–∑–¥–µ–ª—ã —Å —É—á—ë—Ç–æ–º –æ—Ç–≤–µ—Ç–æ–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç—ã –º–µ–Ω—è—é—Ç –≤—ã–≤–æ–¥—ã –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî —É–∫–∞–∂–∏ —ç—Ç–æ —è–≤–Ω–æ. –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π LaTeX. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω."""

FULL_ANALYSIS_PROMPT = """–¢—ã ‚Äî –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç –≤—ã—Å—à–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –ü—Ä–æ–≤–µ–¥–∏ –ü–û–õ–ù–´–ô –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞.

–î–ê–ù–ù–´–ï –ü–ê–¶–ò–ï–ù–¢–ê (–∏–∑ –æ–ø—Ä–æ—Å–∞):
{survey_data}

–ó–ê–ü–†–û–° –ü–ê–¶–ò–ï–ù–¢–ê:
{patient_request}

–ö —Å–æ–æ–±—â–µ–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è). –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã.

–ó–ê–î–ê–ß–ê ‚Äî –¥–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –°–¢–†–û–ì–û –ø–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ (8 –±–ª–æ–∫–æ–≤):

### –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö

**1. –†–ï–ó–Æ–ú–ï –°–õ–£–ß–ê–Ø**
–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –∫—Ç–æ –ø–∞—Ü–∏–µ–Ω—Ç, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è —Å–æ–±—ã—Ç–∏–π. –í–°–ï —Ü–∏—Ñ—Ä—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, –¥–∞—Ç—ã, –∑–Ω–∞—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤, –¥–æ–∑–∏—Ä–æ–≤–∫–∏. –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —á–∏—Å–ª–∞.

**2. –ö–õ–ò–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø**
–ü–æ –∫–∞–∂–¥–æ–º—É –ø–æ–∫–∞–∑–∞—Ç–µ–ª—é –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —É–∫–∞–∂–∏:
- –ó–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Üí –Ω–æ—Ä–º–∞ ‚Üí –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ì–µ–º–æ–≥–ª–æ–±–∏–Ω 98 –≥/–ª –ø—Ä–∏ –Ω–æ—Ä–º–µ 120‚Äì160 –≥/–ª ‚Äî —Å–Ω–∏–∂–µ–Ω –Ω–∞ 18%¬ª)
- –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏
- –°–≤—è–∑–∏ –º–µ–∂–¥—É –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
–ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ —Å–∏—Å—Ç–µ–º–∞–º: –∫—Ä–æ–≤—å, –±–∏–æ—Ö–∏–º–∏—è, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏ —Ç.–¥.

**3. –î–ò–ê–ì–ù–û–ó**
–û—Å–Ω–æ–≤–Ω–æ–π –¥–∏–∞–≥–Ω–æ–∑ (–∏–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π) —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º ‚Äî –∫–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –¥–∞–Ω–Ω—ã–µ –µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç.

**4. –î–ò–§–§–ï–†–ï–ù–¶–ò–ê–õ–¨–ù–´–ô –î–ò–ê–ì–ù–û–ó**
–ö–∞–∫–∏–µ –µ—â—ë –¥–∏–∞–≥–Ω–æ–∑—ã –≤–æ–∑–º–æ–∂–Ω—ã. –ü–æ –∫–∞–∂–¥–æ–º—É: —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç (—Å —Ü–∏—Ñ—Ä–∞–º–∏), —á—Ç–æ –æ–ø—Ä–æ–≤–µ—Ä–≥–∞–µ—Ç.

### –ü–ê–¶–ò–ï–ù–¢–°–ö–ò–ô –ë–õ–û–ö (–ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏)

**5. –ß–¢–û –≠–¢–û –ó–ù–ê–ß–ò–¢ –î–õ–Ø –í–ê–°**
–û–±—ä—è—Å–Ω–∏ –≤—Å—ë –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ, –∫–∞–∫ –ø–æ–∂–∏–ª–æ–º—É —á–µ–ª–æ–≤–µ–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–æ–≥–∏–∏. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è –æ–±—ä—è—Å–Ω–∏: ¬´–í–∞—à –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å X = —Ç–∞–∫–æ–µ-—Ç–æ —á–∏—Å–ª–æ. –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —Ç–∞–∫–æ–µ-—Ç–æ. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç...¬ª. –ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å–µ—Ä—å—ë–∑–Ω–æ, –∫ —á–µ–º—É –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º.

**–°–†–û–ß–ù–û–°–¢–¨:** —Ç—Ä–µ–±—É–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏ / –Ω—É–∂–Ω–∞ –ø–ª–∞–Ω–æ–≤–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è / –º–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å.

### –ß–¢–û –°–î–ï–õ–ê–õ–ò –í–†–ê–ß–ò

**6. –î–ï–ô–°–¢–í–ò–Ø –í–†–ê–ß–ï–ô ‚Äî –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û**
–ü–µ—Ä–µ—á–∏—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, —á—Ç–æ –≤—Ä–∞—á–∏ —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –° –¥–∞—Ç–∞–º–∏ –∏ —Ü–∏—Ñ—Ä–∞–º–∏.

**7. –ß–¢–û –í–†–ê–ß–ò –ù–ï –°–î–ï–õ–ê–õ–ò ‚Äî –û –ß–Å–ú –ù–£–ñ–ù–û –°–ü–†–û–°–ò–¢–¨**
–ü–µ—Ä–µ—á–∏—Å–ª–∏, —á—Ç–æ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ª–µ—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω–æ, –Ω–æ –ù–ï –æ—Ç—Ä–∞–∂–µ–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö. –ü–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É –¥–∞–π:
- –ß—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ
- –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
- –ö–∞–∫ —Å–ø—Ä–æ—Å–∏—Ç—å –≤—Ä–∞—á–∞ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ –Ω–∞ –ø—Ä–∏—ë–º–µ, –≤–µ–∂–ª–∏–≤–æ –Ω–æ –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ)

### –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

**8. –ß–¢–û –î–ï–õ–ê–¢–¨**
- –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏, –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–æ–π—Ç–∏
- –ß–µ–≥–æ —Ç–æ—á–Ω–æ –ù–ï –¥–µ–ª–∞—Ç—å

–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏. –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π LaTeX, —Ñ–æ—Ä–º—É–ª—ã, –∑–Ω–∞–∫–∏ $ –∏–ª–∏ \\text{}. –ß–∏—Å–ª–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: 126 –≥/–ª, 7,76√ó10‚Åπ/–ª, 15 –º–º/—á–∞—Å, –º–µ–Ω–µ–µ 0,14 –≥/–ª). –î–ª—è —Å—Ç–µ–ø–µ–Ω–µ–π –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 10‚Åπ). –í –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –±–ª–æ–∫–µ –∏—Å–ø–æ–ª—å–∑—É–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é —Å —Ü–∏—Ñ—Ä–∞–º–∏. –í –ø–∞—Ü–∏–µ–Ω—Ç—Å–∫–æ–º –±–ª–æ–∫–µ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ –∏—Ö —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π. –ù–µ –ø—É–≥–∞–π, –Ω–æ –Ω–µ —Å–∫—Ä—ã–≤–∞–π –≤–∞–∂–Ω–æ–µ. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –æ–±—â–∏—Ö —Ñ—Ä–∞–∑."""

# –ö–ª—é—á–∏ –≤ user_data –¥–ª—è –±—É—Ñ–µ—Ä–∞ —Ñ–æ—Ç–æ
PENDING_IMAGES_KEY = "pending_images"
PENDING_CHAT_ID_KEY = "pending_chat_id"
BATCH_DELAY_SEC = 10


GROQ_VISION_MODEL = "meta-llama/llama-4-scout-17b-16e-instruct"
GROQ_TEXT_MODEL = "llama-3.3-70b-versatile"


def _use_groq() -> bool:
    return bool(os.getenv("GROQ_API_KEY"))


def get_groq_client() -> Optional[OpenAI]:
    api_key = os.getenv("GROQ_API_KEY")
    if not api_key:
        return None
    return OpenAI(base_url="https://api.groq.com/openai/v1", api_key=api_key)


def get_openai_client() -> Optional[OpenAI]:
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        return None
    return OpenAI(api_key=api_key)


def _no_ai_message() -> str:
    return "–ù–µ –∑–∞–¥–∞–Ω –Ω–∏ –æ–¥–∏–Ω –∫–ª—é—á –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. –î–æ–±–∞–≤—å –≤ .env: GROQ_API_KEY (console.groq.com) –∏–ª–∏ OPENAI_API_KEY (platform.openai.com)."


def _short_error(e: Exception) -> str:
    msg = str(e).strip()
    if "429" in msg or "quota" in msg.lower() or "insufficient_quota" in msg:
        return "–ó–∞–∫–æ–Ω—á–∏–ª—Å—è –ª–∏–º–∏—Ç –ø–æ –∫–ª—é—á—É. Groq: console.groq.com; OpenAI: platform.openai.com."
    if "401" in msg or "invalid" in msg.lower() or "api_key" in msg.lower():
        return "–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π API-–∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á –≤ .env."
    if "access denied" in msg.lower() or "network" in msg.lower():
        return "–î–æ—Å—Ç—É–ø –∫ API –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (—Å–µ—Ç—å –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω). –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∫–ª—é—á –∏–ª–∏ VPN."
    if len(msg) > 200:
        return msg[:197] + "..."
    return msg


def _escape_html(s: str) -> str:
    return (s or "").replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")


def _strip_latex(text: str) -> str:
    """–£–±–∏—Ä–∞–µ—Ç LaTeX-—Ä–∞–∑–º–µ—Ç–∫—É: $...$, \text{}, \times –∏ —Ç.–¥."""
    text = re.sub(r"\$([^$]*)\$", r"\1", text)
    text = re.sub(r"\\text\{([^}]*)\}", r"\1", text)
    text = text.replace("\\times", "√ó")
    text = text.replace("\\cdot", "¬∑")
    text = text.replace("\\leq", "‚â§").replace("\\geq", "‚â•")
    text = text.replace("\\lt", "<").replace("\\gt", ">")
    text = text.replace("\\le", "‚â§").replace("\\ge", "‚â•")
    text = re.sub(r"\^(\d)", lambda m: "‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ"[int(m.group(1))], text)
    text = re.sub(r"\^\{(\d+)\}", lambda m: "".join("‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ"[int(d)] for d in m.group(1)), text)
    text = re.sub(r"\\[a-zA-Z]+", "", text)
    return text


def _format_conclusion_for_elderly(raw: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —ç–º–æ–¥–∑–∏, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, —Ä–∞–∑–±–∏–≤–∫–∞."""
    if not raw or len(raw) > 4000:
        raw = (raw or "")[:4000]
    raw = _strip_latex(raw)
    raw = _escape_html(raw)
    raw = re.sub(r"\*\*(.+?)\*\*", r"<b>\1</b>", raw)

    section_icons = {
        "–ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö": "üè•",
        "–†–ï–ó–Æ–ú–ï –°–õ–£–ß–ê–Ø": "üìã",
        "–ö–õ–ò–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø": "üî¨",
        "–î–ò–ê–ì–ù–û–ó": "ü©∫",
        "–î–ò–§–§–ï–†–ï–ù–¶–ò–ê–õ–¨–ù–´–ô –î–ò–ê–ì–ù–û–ó": "üîç",
        "–ü–ê–¶–ò–ï–ù–¢–°–ö–ò–ô –ë–õ–û–ö": "üí¨",
        "–ß–¢–û –≠–¢–û –ó–ù–ê–ß–ò–¢ –î–õ–Ø –í–ê–°": "üí°",
        "–°–†–û–ß–ù–û–°–¢–¨": "üö®",
        "–ß–¢–û –°–î–ï–õ–ê–õ–ò –í–†–ê–ß–ò": "üë®‚Äç‚öïÔ∏è",
        "–î–ï–ô–°–¢–í–ò–Ø –í–†–ê–ß–ï–ô ‚Äî –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û": "‚úÖ",
        "–ß–¢–û –í–†–ê–ß–ò –ù–ï –°–î–ï–õ–ê–õ–ò ‚Äî –û –ß–Å–ú –ù–£–ñ–ù–û –°–ü–†–û–°–ò–¢–¨": "‚ö†Ô∏è",
        "–ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô": "üìù",
        "–ß–¢–û –î–ï–õ–ê–¢–¨": "üéØ",
    }
    for title, icon in section_icons.items():
        raw = raw.replace(title, f"\n\n{icon} <b>{title}</b>\n")

    raw = re.sub(r"(?m)^#+\s*(.+)$", r"\n<b>\1</b>\n", raw)
    raw = re.sub(r"(?m)^(\d+)\.\s+", r"\n\1Ô∏è‚É£ ", raw)
    raw = re.sub(r"(\d+)\)\s*", r"\n\1Ô∏è‚É£ ", raw)
    raw = re.sub(r"(?m)^-\s+", "  ‚Ä¢ ", raw)
    raw = re.sub(r"(?m)^#+\s*", "", raw)
    raw = re.sub(r"\n{3,}", "\n\n", raw)
    raw = raw.strip()
    if len(raw) > 4080:
        raw = raw[:4077] + "..."
    return raw


def _save_conclusion(user_id: int, conclusion: str) -> None:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ user_id: —Ä–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ –¥–∏–∞–≥–Ω–æ–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ª–µ—á–µ–Ω–∏—é."""
    conclusion = (conclusion or "").strip()
    if not conclusion:
        return
    diagnosis = conclusion
    treatment = ""
    if "–ê–ë–ó–ê–¶ 2" in conclusion:
        parts = conclusion.split("–ê–ë–ó–ê–¶ 2", 1)
        diagnosis = parts[0].strip()
        treatment = ("–ê–ë–ó–ê–¶ 2 " + parts[1]).strip() if len(parts) > 1 else ""
    if user_id not in _user_last:
        _user_last[user_id] = {"diagnosis": "", "treatment": ""}
    _user_last[user_id]["diagnosis"] = diagnosis[:4000]
    _user_last[user_id]["treatment"] = treatment[:4000] if treatment else conclusion[:4000]


async def _ask_openai_image(image_b64: str, mime: str = "image/jpeg") -> str:
    client = get_openai_client()
    if not client:
        return ""
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": MEDICAL_PROMPT},
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": "–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –ø–æ –ø—É–Ω–∫—Ç–∞–º –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."},
                    {"type": "image_url", "image_url": {"url": f"data:{mime};base64,{image_b64}"}},
                ],
            },
        ],
        max_tokens=1500,
    )
    return (response.choices[0].message.content or "").strip()


async def _ask_openai_text(user_text: str) -> str:
    client = get_openai_client()
    if not client:
        return ""
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": TEXT_PROMPT},
            {"role": "user", "content": user_text},
        ],
        max_tokens=1000,
    )
    return (response.choices[0].message.content or "").strip()


def _build_multi_content(images: list) -> list:
    """–°–ø–∏—Å–æ–∫ content –¥–ª—è OpenAI/Groq: —Ç–µ–∫—Å—Ç + –≤—Å–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏."""
    parts = [{"type": "text", "text": "–ü–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º —Å–¥–µ–ª–∞–π –æ–¥–Ω–æ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–¥–≤–∞ –∞–±–∑–∞—Ü–∞, –ø—É–Ω–∫—Ç—ã 1-2-3)."}]
    for b64, mime in images:
        parts.append({"type": "image_url", "image_url": {"url": f"data:{mime};base64,{b64}"}})
    return parts


async def _ask_groq_images(images: list) -> str:
    """images: —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (image_b64, mime)."""
    client = get_groq_client()
    if not client or not images:
        return ""
    content = _build_multi_content(images)
    response = client.chat.completions.create(
        model=GROQ_VISION_MODEL,
        messages=[
            {"role": "system", "content": MULTI_DOC_PROMPT},
            {"role": "user", "content": content},
        ],
        max_tokens=2000,
    )
    return (response.choices[0].message.content or "").strip()


async def _ask_openai_images(images: list) -> str:
    """images: —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (image_b64, mime)."""
    client = get_openai_client()
    if not client or not images:
        return ""
    content = _build_multi_content(images)
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": MULTI_DOC_PROMPT},
            {"role": "user", "content": content},
        ],
        max_tokens=2000,
    )
    return (response.choices[0].message.content or "").strip()


async def _ask_groq_image(image_b64: str, mime: str = "image/jpeg") -> str:
    client = get_groq_client()
    if not client:
        return ""
    response = client.chat.completions.create(
        model=GROQ_VISION_MODEL,
        messages=[
            {"role": "system", "content": MEDICAL_PROMPT},
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": "–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –ø–æ –ø—É–Ω–∫—Ç–∞–º –∏–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."},
                    {"type": "image_url", "image_url": {"url": f"data:{mime};base64,{image_b64}"}},
                ],
            },
        ],
        max_tokens=1500,
    )
    return (response.choices[0].message.content or "").strip()


def _format_survey_data(answers: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –æ–ø—Ä–æ—Å–∞ –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ –ò–ò."""
    if not answers:
        return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–∞."
    lines = []
    for i, (q_tuple) in enumerate(MEDICAL_QUESTIONS):
        q_text = q_tuple[0]
        val = answers.get(f"q{i+1}", "").strip()
        if val:
            lines.append(f"- {q_text}: {val}")
    return "\n".join(lines) if lines else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ä–æ—Å–∞."


def _parse_questions_from_ai(response: str) -> List[str]:
    """–ò–∑ –æ—Ç–≤–µ—Ç–∞ –ò–ò –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ (–¥–æ 5). –£–±–∏—Ä–∞–µ—Ç –Ω—É–º–µ—Ä–∞—Ü–∏—é."""
    if not response or not response.strip():
        return []
    lines = [line.strip() for line in response.strip().splitlines() if line.strip()]
    cleaned: List[str] = []
    for line in lines:
        s = re.sub(r"^\s*\d+[\.\)]\s*", "", line).strip()
        if s and len(s) > 3:
            cleaned.append(s)
    return cleaned[:5]


async def _ask_ai_text(system_prompt: str, user_text: str) -> str:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –ò–ò (Groq, –∑–∞—Ç–µ–º OpenAI)."""
    text = ""
    client = get_groq_client()
    if client:
        try:
            resp = client.chat.completions.create(
                model=GROQ_TEXT_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_text},
                ],
                max_tokens=2000,
            )
            text = (resp.choices[0].message.content or "").strip()
        except Exception as e:
            logger.warning("Groq text: %s", e)
    if not text:
        client = get_openai_client()
        if client:
            try:
                resp = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_text},
                    ],
                    max_tokens=2000,
                )
                text = (resp.choices[0].message.content or "").strip()
            except Exception as e:
                logger.warning("OpenAI text: %s", e)
    return text


async def _ask_ai_with_images(system_prompt: str, user_text: str, images: list) -> str:
    """–ó–∞–ø—Ä–æ—Å –∫ –ò–ò —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (Groq, –∑–∞—Ç–µ–º OpenAI)."""
    content = [{"type": "text", "text": user_text}]
    for b64, mime in images:
        content.append({"type": "image_url", "image_url": {"url": f"data:{mime};base64,{b64}"}})
    text = ""
    client = get_groq_client()
    if client:
        try:
            resp = client.chat.completions.create(
                model=GROQ_VISION_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": content},
                ],
                max_tokens=3000,
            )
            text = (resp.choices[0].message.content or "").strip()
        except Exception as e:
            logger.warning("Groq vision: %s", e)
    if not text:
        client = get_openai_client()
        if client:
            try:
                resp = client.chat.completions.create(
                    model="gpt-4o",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": content},
                    ],
                    max_tokens=3000,
                )
                text = (resp.choices[0].message.content or "").strip()
            except Exception as e:
                logger.warning("OpenAI vision: %s", e)
    return text


async def _ask_groq_text(user_text: str) -> str:
    client = get_groq_client()
    if not client:
        return ""
    response = client.chat.completions.create(
        model=GROQ_TEXT_MODEL,
        messages=[
            {"role": "system", "content": TEXT_PROMPT},
            {"role": "user", "content": user_text},
        ],
        max_tokens=1000,
    )
    return (response.choices[0].message.content or "").strip()


def _progress_bar(pct: int) -> str:
    """–ü–æ–ª–æ—Å–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ 0‚Äì100%."""
    n = 10
    filled = round(n * pct / 100)
    bar = "‚ñà" * filled + "‚ñë" * (n - filled)
    return f"[{bar}] {pct}%"


async def _progress_updater(bot: Any, chat_id: int, message_id: int, stop_event: asyncio.Event) -> None:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª–æ—Å–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (0‚Üí95%), –ø–æ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω stop_event."""
    for i in range(1, 16):
        if stop_event.is_set():
            return
        pct = min(95, i * 6)
        try:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ‚Ä¶\n\n{_progress_bar(pct)}",
            )
        except Exception:
            pass
        await asyncio.sleep(1)
    # –î–µ—Ä–∂–∏–º 95% –ø–æ–∫–∞ –Ω–µ —Å–∫–∞–∂—É—Ç —Å—Ç–æ–ø
    while not stop_event.is_set():
        await asyncio.sleep(0.5)


async def _process_pending_images(
    context: ContextTypes.DEFAULT_TYPE, user_id: int, provider: Optional[str] = None
) -> None:
    """–°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ –±—É—Ñ–µ—Ä–∞, –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–æ—Å—É –∑–∞–≥—Ä—É–∑–∫–∏, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é AI, –≤—ã–¥–∞—Ç—å –æ–¥–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    provider: "groq" | "openai" | None (None = —Å–Ω–∞—á–∞–ª–∞ Groq, –ø—Ä–∏ –æ—à–∏–±–∫–µ OpenAI)."""
    data = _pending.pop(user_id, None)
    if not data:
        return
    chat_id = data["chat_id"]
    file_ids = data["file_ids"]
    if not file_ids:
        return
    bot = context.bot
    images_b64: List[tuple] = []
    for file_id, mime in file_ids:
        try:
            tg_file = await bot.get_file(file_id)
            buf = io.BytesIO()
            await tg_file.download_to_memory(buf)
            buf.seek(0)
            raw = buf.read()
            images_b64.append((base64.b64encode(raw).decode("utf-8"), mime))
        except Exception as e:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª %s: %s", file_id, e)
    if not images_b64:
        await bot.send_message(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞.", reply_markup=MAIN_KEYBOARD)
        return

    # –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ¬ª —Å –ø–æ–ª–æ—Å–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    progress_msg = await bot.send_message(
        chat_id,
        f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ‚Ä¶\n\n{_progress_bar(0)}",
    )
    stop_event = asyncio.Event()
    progress_task = asyncio.create_task(_progress_updater(bot, chat_id, progress_msg.message_id, stop_event))

    text = ""
    last_err = None
    has_groq = _use_groq()
    has_openai = bool(get_openai_client())
    try:
        if provider == "groq" and has_groq:
            try:
                text = await _ask_groq_images(images_b64)
            except Exception as e:
                last_err = e
                logger.warning("Groq –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ: %s", e)
        elif provider == "openai" and has_openai:
            try:
                text = await _ask_openai_images(images_b64)
            except Exception as e:
                last_err = e
                logger.warning("OpenAI –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ: %s", e)
        else:
            # provider is None or –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º Groq, –ø–æ—Ç–æ–º OpenAI
            if has_groq:
                try:
                    text = await _ask_groq_images(images_b64)
                except Exception as e:
                    last_err = e
                    logger.warning("Groq –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ: %s", e)
            if not text and has_openai:
                try:
                    text = await _ask_openai_images(images_b64)
                except Exception as e:
                    last_err = e
                    logger.warning("OpenAI –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ: %s", e)
    finally:
        stop_event.set()
        progress_task.cancel()
        try:
            await progress_task
        except asyncio.CancelledError:
            pass
        try:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=progress_msg.message_id,
                text=f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ‚Ä¶\n\n{_progress_bar(100)}",
            )
        except Exception:
            pass
        await asyncio.sleep(0.3)
        try:
            await bot.delete_message(chat_id=chat_id, message_id=progress_msg.message_id)
        except Exception:
            pass

    if not text:
        await bot.send_message(
            chat_id,
            "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ. " + (_short_error(last_err) if last_err else "–ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á–∏ –≤ .env."),
            reply_markup=MAIN_KEYBOARD,
        )
        return
    if len(text) > 4000:
        text = text[:3997] + "..."
    _save_conclusion(user_id, text)
    formatted = _format_conclusion_for_elderly(text)
    await bot.send_message(
        chat_id,
        formatted,
        reply_markup=MAIN_KEYBOARD,
        parse_mode="HTML",
    )


async def _job_process_pending(context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = context.job.data
    await _process_pending_images(context, user_id, provider="groq")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    for key in list(context.user_data.keys()):
        if key.startswith("awaiting_"):
            context.user_data.pop(key, None)

    welcome = (
        "<b>–ü—Ä–∏–≤–µ—Ç!</b> üëã\n\n"
        "–Ø ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º. –†–∞–∑–±–∏—Ä–∞—é –∞–Ω–∞–ª–∏–∑—ã –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –≤—Ä–∞—á–µ–π –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, "
        "—á—Ç–æ–±—ã –≤—ã –∏ –≤–∞—à–∏ –±–ª–∏–∑–∫–∏–µ –º–æ–≥–ª–∏ —Å–ø–æ–∫–æ–π–Ω–æ –ø–æ–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∑–Ω–∞—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ.\n\n"
        "<b>–ß–µ–º —è –ø–æ–ª–µ–∑–µ–Ω:</b>\n"
        "1Ô∏è‚É£ –û–±—ä—è—Å–Ω—è—é –∞–Ω–∞–ª–∏–∑—ã –∏ –≤—ã–ø–∏—Å–∫–∏ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤\n"
        "2Ô∏è‚É£ –ü–æ–¥—Å–∫–∞–∑—ã–≤–∞—é, —á—Ç–æ –≤ –Ω–æ—Ä–º–µ, –∞ –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ\n"
        "3Ô∏è‚É£ –î–∞—é –ø–æ–Ω—è—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –∫ –≤—Ä–∞—á—É –ª–∏ –∏–¥—Ç–∏ –∏ –æ —á—ë–º —Å–ø—Ä–æ—Å–∏—Ç—å\n"
        "4Ô∏è‚É£ –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º\n\n"
        "–î–ª—è –Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å."
    )
    auth_kb = InlineKeyboardMarkup([
        [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
        [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_REGISTER)],
    ])
    await update.message.reply_text(
        welcome,
        reply_markup=auth_kb,
        parse_mode="HTML",
    )


def _next_step_keyboard() -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏: –æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üìã –ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å", callback_data=CB_NEXT_SURVEY)],
        [InlineKeyboardButton("üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã", callback_data=CB_NEXT_UPLOAD)],
    ])


def _survey_send_keyboard() -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç¬ª –≤ –æ–ø—Ä–æ—Å–µ."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç", callback_data=CB_SURVEY_SEND)],
    ])


def _start_button_keyboard() -> InlineKeyboardMarkup:
    """–ö–Ω–æ–ø–∫–∞ ¬´–ù–∞—á–∞—Ç—å¬ª –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–ù–∞—á–∞—Ç—å", callback_data=CB_FLOW_START)],
    ])


def _consent_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–≥–ª–∞—Å–µ–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å / –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ –±–ª–æ–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è."""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–°–æ–≥–ª–∞—Å–µ–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data=CB_CONSENT_ACCEPT)],
        [InlineKeyboardButton("–ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω", callback_data=CB_CONSENT_DECLINE)],
    ])


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text(
        "/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n"
        "/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "–ö–Ω–æ–ø–∫–∏: –°—Ç–∞—Ä—Ç, –°—Ç–æ–ø, –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å, –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ, –î–∏–∞–≥–Ω–æ–∑ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ), –õ–µ—á–µ–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏).\n\n"
        "–ú–æ–∂–Ω–æ –ø—Ä–∏—Å–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –ø–æ–¥—Ä—è–¥ ‚Äî —á–µ—Ä–µ–∑ 10 —Å–µ–∫ —Ä–∞–∑–±–µ—Ä—É –≤–º–µ—Å—Ç–µ (–∏–ª–∏ –≤—ã–±–µ—Ä–∏ –ò–ò –∫–Ω–æ–ø–∫–æ–π). –ò–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–≤—Å—ë¬ª / ¬´–≥–æ—Ç–æ–≤–æ¬ª. –í–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º ‚Äî –æ—Ç–≤–µ—á—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.",
        reply_markup=MAIN_KEYBOARD,
    )


def _schedule_pending_job(context: ContextTypes.DEFAULT_TYPE, user_id: int) -> None:
    """–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–±–æ—Ä –±—É—Ñ–µ—Ä–∞ —á–µ—Ä–µ–∑ BATCH_DELAY_SEC: —á–µ—Ä–µ–∑ job_queue –∏–ª–∏ asyncio."""
    if context.job_queue:
        job_name = f"process_pending_{user_id}"
        for job in context.job_queue.jobs():
            if job.name == job_name:
                job.schedule_removal()
                break
        context.job_queue.run_once(
            _job_process_pending,
            when=BATCH_DELAY_SEC,
            data=user_id,
            name=job_name,
        )
        return
    # –ë–µ–∑ job_queue ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ asyncio
    old = _pending_tasks.pop(user_id, None)
    if old and not old.done():
        old.cancel()
    async def _delayed_batch(app: Any, uid: int) -> None:
        await asyncio.sleep(BATCH_DELAY_SEC)
        _pending_tasks.pop(uid, None)
        class _C:
            pass
        ctx = _C()
        ctx.bot = app.bot
        await _process_pending_images(ctx, uid, provider="groq")
    _pending_tasks[user_id] = asyncio.create_task(_delayed_batch(context.application, user_id))


def _add_to_pending(user_id: int, chat_id: int, file_id: str, mime: str) -> int:
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –≤ –±—É—Ñ–µ—Ä _pending, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª-–≤–æ —Ñ–∞–π–ª–æ–≤."""
    if user_id not in _pending:
        _pending[user_id] = {"chat_id": chat_id, "file_ids": []}
    _pending[user_id]["chat_id"] = chat_id
    _pending[user_id]["file_ids"].append((file_id, mime))
    return len(_pending[user_id]["file_ids"])


async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    has_groq = _use_groq()
    has_openai = bool(get_openai_client())
    if not has_groq and not has_openai:
        await update.message.reply_text(_no_ai_message())
        return

    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    photo = update.message.photo[-1]
    n = _add_to_pending(user_id, chat_id, photo.file_id, "image/jpeg")

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìé –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑", callback_data=CB_SEND_DOCS)],
    ])
    if context.user_data.get("collecting_docs"):
        await update.message.reply_text(
            f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç ({n}). –ó–∞–≥—Ä—É–∑–∏—Ç–µ –µ—â—ë –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            reply_markup=keyboard,
        )
        return

    _schedule_pending_job(context, user_id)
    await update.message.reply_text(
        f"‚úÖ –ü–æ–ª—É—á–∏–ª ({n}). –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.",
        reply_markup=keyboard,
    )


async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    doc = update.message.document
    if doc.mime_type and not doc.mime_type.startswith("image/"):
        await update.message.reply_text(
            "–ü–æ–∫–∞ –ø—Ä–∏–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (JPEG, PNG). PDF –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é ‚Äî –ø—Ä–∏—à–ª–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã."
        )
        return

    has_groq = _use_groq()
    has_openai = bool(get_openai_client())
    if not has_groq and not has_openai:
        await update.message.reply_text(_no_ai_message())
        return

    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    mime = (doc.mime_type or "image/jpeg").strip()
    if mime not in ("image/jpeg", "image/png", "image/gif", "image/webp"):
        mime = "image/jpeg"

    n = _add_to_pending(user_id, chat_id, doc.file_id, mime)

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìé –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑", callback_data=CB_SEND_DOCS)],
    ])
    if context.user_data.get("collecting_docs"):
        await update.message.reply_text(
            f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç ({n}). –ó–∞–≥—Ä—É–∑–∏—Ç–µ –µ—â—ë –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            reply_markup=keyboard,
        )
        return

    _schedule_pending_job(context, user_id)
    await update.message.reply_text(
        f"‚úÖ –ü–æ–ª—É—á–∏–ª ({n}). –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.",
        reply_markup=keyboard,
    )


async def handle_ai_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ò–ò (Groq / OpenAI)."""
    query = update.callback_query
    await query.answer()
    data = (query.data or "").strip()
    user_id = query.from_user.id if query.from_user else 0
    if user_id not in _pending or not _pending[user_id].get("file_ids"):
        await query.edit_message_text("–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ –Ω–µ—Ç. –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª—ã.")
        return
    provider = None
    if data == CB_GROQ:
        provider = "groq"
    elif data == CB_OPENAI:
        provider = "openai"
    if not provider:
        return
    # –û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø–æ —Ç–∞–π–º–µ—Ä—É
    if context.job_queue:
        job_name = f"process_pending_{user_id}"
        for job in context.job_queue.jobs():
            if job.name == job_name:
                job.schedule_removal()
                break
    task = _pending_tasks.pop(user_id, None)
    if task and not task.done():
        task.cancel()
    try:
        await query.edit_message_text("–ó–∞–ø—É—Å–∫–∞—é –∞–Ω–∞–ª–∏–∑‚Ä¶")
    except Exception:
        pass
    await _process_pending_images(context, user_id, provider=provider)


def _format_medical_question(step: int, total: int) -> str:
    """–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞."""
    q, variants = MEDICAL_QUESTIONS[step - 1]
    line = f"<b>–í–æ–ø—Ä–æ—Å {step} –∏–∑ {total}</b>\n\n{q}"
    if variants:
        line += "\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –∫–Ω–æ–ø–∫–æ–π –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π."
    else:
        line += "\n\n–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ Enter."
    return line


def _survey_done_message(user_id_sheet) -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞ —Å ID ‚Äî –ø—Ä–æ—Å–∏–º –æ–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å."""
    id_line = ""
    if user_id_sheet is not None:
        id_line = f"\n\n–í–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π <b>ID: {user_id_sheet}</b>. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ ‚Äî –æ–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–∞—à–µ–π –∫–∞—Ä—Ç–µ."
    return (
        f"–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã! –û–Ω–∏ –ø–æ–º–æ–≥—É—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑.{id_line}\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        "–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –æ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏:\n\n"
        "  ‚Äî –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? –ß—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?\n"
        "  ‚Äî –í —Å–≤—è–∑–∏ —Å —á–µ–º –≤—ã —Ä–µ—à–∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è?\n"
        "  ‚Äî –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –∏ –ø–æ –∫–∞–∫–æ–π –ø—Ä–∏—á–∏–Ω–µ –æ–Ω–∏ –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã.\n\n"
        "–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤—ã –æ–ø–∏—à–µ—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é ‚Äî —Å–∏–º–ø—Ç–æ–º—ã, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é —Å–æ–±—ã—Ç–∏–π, "
        "–æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ –∏ –≥–ª—É–±–∂–µ —è —Å–º–æ–≥—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ "
        "–∏ –¥–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.\n\n"
        "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."
    )


def _survey_question_keyboard(step: int) -> InlineKeyboardMarkup:
    """–ò–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) + –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å."""
    _, variants = MEDICAL_QUESTIONS[step - 1]
    buttons: list[list[InlineKeyboardButton]] = []
    if variants:
        for i, v in enumerate(variants.split(" / ")):
            buttons.append([InlineKeyboardButton(v.strip(), callback_data=f"survey:ans:{i}")])
    buttons.append([InlineKeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="survey:skip")])
    return InlineKeyboardMarkup(buttons)


async def _send_survey_question(
    bot, chat_id: int, step: int, total: int, *, remove_reply_kb: bool = False
) -> "telegram.Message":
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏. –ü—Ä–∏ remove_reply_kb —É–±–∏—Ä–∞–µ—Ç –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É."""
    q_text = _format_medical_question(step, total)
    kb = _survey_question_keyboard(step)
    if remove_reply_kb:
        sent = await bot.send_message(chat_id, q_text, parse_mode="HTML", reply_markup=ReplyKeyboardRemove())
        try:
            await bot.edit_message_reply_markup(chat_id=chat_id, message_id=sent.message_id, reply_markup=kb)
        except Exception:
            pass
    else:
        sent = await bot.send_message(chat_id, q_text, parse_mode="HTML", reply_markup=kb)
    return sent


async def handle_auth_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–Ω–æ–ø–∫–∏ '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è' / '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' –ø–æ—Å–ª–µ /start."""
    query = update.callback_query
    await query.answer()
    data = (query.data or "").strip()
    chat_id = query.message.chat_id
    bot = context.bot

    try:
        await query.message.delete()
    except Exception:
        pass

    for key in list(context.user_data.keys()):
        if key.startswith("awaiting_"):
            context.user_data.pop(key, None)

    if data == CB_AUTH_LOGIN:
        context.user_data["awaiting_login_email"] = True
        await bot.send_message(
            chat_id,
            "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>email</b> (–ª–æ–≥–∏–Ω):",
            parse_mode="HTML",
            reply_markup=MAIN_KEYBOARD,
        )
    elif data == CB_AUTH_REGISTER:
        context.user_data["awaiting_reg_email"] = True
        await bot.send_message(
            chat_id,
            "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à <b>email</b> –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:",
            parse_mode="HTML",
            reply_markup=MAIN_KEYBOARD,
        )
    elif data == CB_FORGOT_PASSWORD:
        saved_email = context.user_data.get("login_email", "").strip()
        if saved_email and "@" in saved_email:
            await bot.send_message(chat_id, "–°–±—Ä–∞—Å—ã–≤–∞—é –ø–∞—Ä–æ–ª—å‚Ä¶", reply_markup=MAIN_KEYBOARD)
            new_pw = await asyncio.to_thread(_reset_user_password, saved_email)
            if new_pw:
                login_kb = InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
                ])
                await bot.send_message(
                    chat_id,
                    f"–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è <b>{_escape_html(saved_email)}</b>:\n\n"
                    f"<code>{new_pw}</code>\n\n"
                    "–ó–∞–ø–æ–º–Ω–∏—Ç–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏.",
                    parse_mode="HTML",
                    reply_markup=login_kb,
                )
            else:
                retry_kb = InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
                    [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_REGISTER)],
                ])
                await bot.send_message(
                    chat_id,
                    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n"
                    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.",
                    parse_mode="HTML",
                    reply_markup=retry_kb,
                )
        else:
            context.user_data["awaiting_reset_email"] = True
            await bot.send_message(
                chat_id,
                "–í–≤–µ–¥–∏—Ç–µ <b>email</b>, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n"
                "–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ –Ω–µ–≥–æ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.",
                parse_mode="HTML",
                reply_markup=MAIN_KEYBOARD,
            )


async def handle_flow_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–Ω–æ–ø–∫–∞ ¬´–ù–∞—á–∞—Ç—å¬ª ‚Äî —É–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–¥–∏–Ω—ã–π –±–ª–æ–∫ —Å–æ–≥–ª–∞—Å–∏—è."""
    query = update.callback_query
    await query.answer()
    try:
        await query.message.delete()
    except Exception:
        pass
    await context.bot.send_message(
        query.message.chat_id,
        CONSENT_TEXT,
        parse_mode="HTML",
        reply_markup=_consent_keyboard(),
    )


async def handle_consent(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–°–æ–≥–ª–∞—Å–µ–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–Ω–∏–∫–∞; –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω ‚Üí —Å—Ç–æ–ø."""
    query = update.callback_query
    data = (query.data or "").strip()
    chat_id = query.message.chat_id
    bot = context.bot
    if data == CB_CONSENT_DECLINE:
        await query.answer()
        try:
            await query.message.delete()
        except Exception:
            pass
        await bot.send_message(
            chat_id,
            "–ú—ã —É–≤–∞–∂–∞–µ–º –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ.\n\n"
            "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º. "
            "–ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ /start –∏ –ø—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è.",
            reply_markup=MAIN_KEYBOARD,
        )
        return
    if data != CB_CONSENT_ACCEPT:
        return
    await query.answer()
    try:
        await query.message.delete()
    except Exception:
        pass
    context.user_data["survey_step"] = 1
    context.user_data["survey_answers"] = {}
    user = update.effective_user
    tg_username = f"@{user.username}" if user and user.username else (user.full_name if user else "")
    sheet_row, sheet_id, _ = await asyncio.to_thread(_sheet_start_row, tg_username, "")
    if sheet_row is not None and sheet_id is not None:
        context.user_data["survey_sheet_row"] = sheet_row
        context.user_data["survey_sheet_id"] = sheet_id
    else:
        context.user_data.pop("survey_sheet_row", None)
        context.user_data.pop("survey_sheet_id", None)
    total_q = len(MEDICAL_QUESTIONS)
    sent = await _send_survey_question(bot, chat_id, 1, total_q, remove_reply_kb=True)
    context.user_data["survey_question_message_id"] = sent.message_id


async def handle_next_step(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """¬´–ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å¬ª –∏–ª–∏ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã¬ª (–µ—Å–ª–∏ –æ–ø—Ä–æ—Å–Ω–∏–∫ –∑–∞–ø—É—â–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ)."""
    query = update.callback_query
    await query.answer()
    data = (query.data or "").strip()
    if data == CB_NEXT_SURVEY:
        context.user_data["survey_step"] = 1
        context.user_data["survey_answers"] = {}
        user = update.effective_user
        tg_username = f"@{user.username}" if user and user.username else (user.full_name if user else "")
        sheet_row, sheet_id, _ = await asyncio.to_thread(_sheet_start_row, tg_username, "")
        if sheet_row is not None and sheet_id is not None:
            context.user_data["survey_sheet_row"] = sheet_row
            context.user_data["survey_sheet_id"] = sheet_id
        else:
            context.user_data.pop("survey_sheet_row", None)
            context.user_data.pop("survey_sheet_id", None)
        total = len(MEDICAL_QUESTIONS)
        chat_id = query.message.chat_id
        try:
            await query.message.delete()
        except Exception:
            pass
        sent = await _send_survey_question(context.bot, chat_id, 1, total, remove_reply_kb=True)
        context.user_data["survey_question_message_id"] = sent.message_id
    elif data == CB_NEXT_UPLOAD:
        upload_text = (
            "–ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª —Å –∞–Ω–∞–ª–∏–∑–æ–º/–∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º. –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî "
            "—á–µ—Ä–µ–∑ 10 —Å–µ–∫ —Ä–∞–∑–±–µ—Ä—É –≤–º–µ—Å—Ç–µ (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Groq) –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ò."
        )
        try:
            await query.edit_message_text(upload_text, reply_markup=MAIN_KEYBOARD)
        except Exception:
            await query.message.reply_text(upload_text, reply_markup=MAIN_KEYBOARD)


async def handle_survey_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞: –≤—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ (survey:ans:N), –ø—Ä–æ–ø—É—Å–∫ (survey:skip)."""
    query = update.callback_query
    data = (query.data or "").strip()
    step = context.user_data.get("survey_step", 0)
    if not step or step < 1 or step > len(MEDICAL_QUESTIONS):
        await query.answer()
        return

    if data == "survey:skip":
        answer_val = ""
    elif data.startswith("survey:ans:"):
        try:
            idx = int(data.split(":")[-1])
        except (ValueError, IndexError):
            await query.answer()
            return
        _, variants = MEDICAL_QUESTIONS[step - 1]
        if variants:
            opts = [v.strip() for v in variants.split(" / ")]
            answer_val = opts[idx] if idx < len(opts) else ""
        else:
            answer_val = ""
    else:
        await query.answer()
        return

    await query.answer()
    if "survey_answers" not in context.user_data:
        context.user_data["survey_answers"] = {}
    context.user_data["survey_answers"][f"q{step}"] = answer_val

    sheet_row = context.user_data.get("survey_sheet_row")
    if sheet_row is not None:
        await asyncio.to_thread(_sheet_update_answer, sheet_row, step, answer_val)

    chat_id = query.message.chat_id
    bot = context.bot
    try:
        await query.message.delete()
    except Exception:
        pass

    next_step = step + 1
    total = len(MEDICAL_QUESTIONS)
    if next_step <= total:
        context.user_data["survey_step"] = next_step
        sent = await _send_survey_question(bot, chat_id, next_step, total)
        context.user_data["survey_question_message_id"] = sent.message_id
    else:
        user_id_sheet = context.user_data.pop("survey_sheet_id", None)
        saved_answers = dict(context.user_data.get("survey_answers") or {})
        context.user_data.pop("survey_step", None)
        context.user_data.pop("survey_answers", None)
        context.user_data.pop("survey_question_message_id", None)
        context.user_data.pop("survey_sheet_row", None)
        context.user_data["completed_survey_answers"] = saved_answers
        context.user_data["awaiting_request"] = True
        await bot.send_message(
            chat_id,
            _survey_done_message(user_id_sheet),
            parse_mode="HTML",
            reply_markup=MAIN_KEYBOARD,
        )


async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_text = (update.message.text or "").strip()
    if not user_text:
        return

    # ---- –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è: –≤–≤–æ–¥ email ----
    if context.user_data.get("awaiting_reset_email"):
        context.user_data["awaiting_reset_email"] = False
        email = user_text.strip().lower()
        if "@" not in email or "." not in email:
            context.user_data["awaiting_reset_email"] = True
            await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
            return
        await update.message.reply_text("–ü—Ä–æ–≤–µ—Ä—è—é...")
        new_pw = await asyncio.to_thread(_reset_user_password, email)
        if new_pw:
            login_kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
            ])
            await update.message.reply_text(
                f"–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è <b>{_escape_html(email)}</b>:\n\n"
                f"<code>{new_pw}</code>\n\n"
                "–ó–∞–ø–æ–º–Ω–∏—Ç–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏.",
                parse_mode="HTML",
                reply_markup=login_kb,
            )
        else:
            retry_kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
                [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_REGISTER)],
            ])
            await update.message.reply_text(
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.",
                parse_mode="HTML",
                reply_markup=retry_kb,
            )
        return

    # ---- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –≤–≤–æ–¥ email ----
    if context.user_data.get("awaiting_login_email"):
        context.user_data["awaiting_login_email"] = False
        context.user_data["login_email"] = user_text.strip().lower()
        context.user_data["awaiting_login_password"] = True
        forgot_kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("üîÑ –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?", callback_data=CB_FORGOT_PASSWORD)],
        ])
        await update.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ <b>–ø–∞—Ä–æ–ª—å</b>:",
            parse_mode="HTML",
            reply_markup=forgot_kb,
        )
        return

    # ---- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è ----
    if context.user_data.get("awaiting_login_password"):
        context.user_data["awaiting_login_password"] = False
        email = context.user_data.pop("login_email", "")
        password = user_text.strip()

        await update.message.reply_text("–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶")
        user_rec = await asyncio.to_thread(_check_password, email, password)
        if user_rec:
            tg_user = update.effective_user
            tg_username = f"@{tg_user.username}" if tg_user and tg_user.username else (tg_user.full_name if tg_user else "")
            await asyncio.to_thread(_update_user_tg, email, user_id, tg_username)
            context.user_data["authenticated"] = True
            context.user_data["auth_email"] = email
            context.user_data["collecting_docs"] = True
            context.user_data["awaiting_request"] = True
            await update.message.reply_text(
                f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{_escape_html(email)}</b>! üëã\n\n"
                "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? –ß—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?\n\n"
                "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º, –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.",
                parse_mode="HTML",
                reply_markup=MAIN_KEYBOARD,
            )
        else:
            retry_kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
                [InlineKeyboardButton("üîÑ –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?", callback_data=CB_FORGOT_PASSWORD)],
            ])
            await update.message.reply_text(
                "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å, –ª–∏–±–æ –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                parse_mode="HTML",
                reply_markup=retry_kb,
            )
        return

    # ---- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: –≤–≤–æ–¥ email ----
    if context.user_data.get("awaiting_reg_email"):
        context.user_data["awaiting_reg_email"] = False
        email = user_text.strip().lower()
        if "@" not in email or "." not in email:
            context.user_data["awaiting_reg_email"] = True
            await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
            return
        existing = await asyncio.to_thread(_find_user_by_email, email)
        if existing:
            exists_kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è", callback_data=CB_AUTH_LOGIN)],
                [InlineKeyboardButton("üîÑ –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?", callback_data=CB_FORGOT_PASSWORD)],
                [InlineKeyboardButton("üë§ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", callback_data=CB_AUTH_REGISTER)],
            ])
            await update.message.reply_text(
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=exists_kb,
            )
            return
        context.user_data["reg_email"] = email
        context.user_data["awaiting_reg_password"] = True
        await update.message.reply_text("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ <b>–ø–∞—Ä–æ–ª—å</b> (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞):", parse_mode="HTML")
        return

    # ---- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è ----
    if context.user_data.get("awaiting_reg_password"):
        context.user_data["awaiting_reg_password"] = False
        password = user_text.strip()
        if len(password) < 4:
            context.user_data["awaiting_reg_password"] = True
            await update.message.reply_text("–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
            return
        email = context.user_data.get("reg_email", "")
        tg_user = update.effective_user
        tg_username = f"@{tg_user.username}" if tg_user and tg_user.username else (tg_user.full_name if tg_user else "")

        err = await asyncio.to_thread(_create_user, email, password, user_id, tg_username)
        if err:
            await update.message.reply_text(f"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {err}\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start –∑–∞–Ω–æ–≤–æ.")
            return

        code = str(random.randint(100000, 999999))
        context.user_data["confirm_code"] = code
        context.user_data["confirm_email"] = email
        context.user_data["awaiting_confirm_code"] = True
        await update.message.reply_text(
            f"–í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: <b>{code}</b>\n\n"
            "–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∏–∂–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.",
            parse_mode="HTML",
        )
        return

    # ---- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: –≤–≤–æ–¥ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ----
    if context.user_data.get("awaiting_confirm_code"):
        context.user_data["awaiting_confirm_code"] = False
        expected = context.user_data.pop("confirm_code", "")
        email = context.user_data.pop("confirm_email", "")
        if user_text.strip() == expected:
            ok = await asyncio.to_thread(_confirm_user, email)
            if ok:
                context.user_data["authenticated"] = True
                context.user_data["auth_email"] = email
                context.user_data.pop("reg_email", None)
                await update.message.reply_text(
                    "–ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n\n"
                    "–¢–µ–ø–µ—Ä—å –ø—Ä–æ–π–¥—ë–º –∫–æ—Ä–æ—Ç–∫—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Å–æ–≥–ª–∞—Å–∏—è.",
                )
                await context.bot.send_message(
                    update.effective_chat.id,
                    CONSENT_TEXT,
                    parse_mode="HTML",
                    reply_markup=_consent_keyboard(),
                )
            else:
                await update.message.reply_text("–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start –∑–∞–Ω–æ–≤–æ.")
        else:
            context.user_data["confirm_code"] = expected
            context.user_data["confirm_email"] = email
            context.user_data["awaiting_confirm_code"] = True
            await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
        return

    # –û–∂–∏–¥–∞–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ /start ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ò–ò, –Ω–µ –∏—â–µ–º –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
    if context.user_data.get("awaiting_client_name"):
        context.user_data["awaiting_client_name"] = False
        context.user_data["client_name"] = user_text[:200]
        await update.message.reply_text(
            f"–ó–∞–ø–∏—Å–∞–ª: <b>{_escape_html(user_text[:200])}</b>.\n\n–ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?",
            reply_markup=_next_step_keyboard(),
            parse_mode="HTML",
        )
        return

    # –ó–∞–ø—Ä–æ—Å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–∞ ‚Äî –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ò–ò-–¥–∏–∞–≥–Ω–æ—Å—Ç–∞
    if context.user_data.get("awaiting_request"):
        await _handle_patient_request(update, context, user_text)
        return

    # –û—Ç–≤–µ—Ç—ã –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ò–ò (–ø–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏)
    if context.user_data.get("awaiting_followup_answers"):
        context.user_data["awaiting_followup_answers"] = False
        context.user_data.pop("ai_followup_questions", None)
        patient_request = context.user_data.get("patient_request", "")
        survey_answers = context.user_data.get("completed_survey_answers") or {}
        survey_data = _format_survey_data(survey_answers)
        await _finish_patient_request_with_docs(
            update, context, survey_data, patient_request, followup_answers=user_text
        )
        return

    # –û—Ç–≤–µ—Ç—ã –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if context.user_data.get("awaiting_post_doc_answers"):
        context.user_data["awaiting_post_doc_answers"] = False
        context.user_data.pop("post_doc_followup_questions", None)
        full_analysis = context.user_data.get("full_analysis", "")
        if full_analysis:
            qa_block = "–û—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:\n" + user_text[:2000]
            refine_prompt = REFINED_ANALYSIS_PROMPT.format(
                full_analysis=full_analysis[:6000],
                qa_block=qa_block,
            )
            await update.message.reply_text("–£—Ç–æ—á–Ω—è—é –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤‚Ä¶")
            refined = await _ask_ai_text(refine_prompt, qa_block)
            if refined:
                refined = _strip_latex(refined)
                context.user_data["full_analysis"] = refined
                _save_conclusion(update.effective_user.id, refined)
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("üìÑ –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data=CB_SHOW_RESULTS)],
            ])
            await update.message.reply_text(
                "–ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ.",
                reply_markup=keyboard,
            )
        return

    # –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ–ø—Ä–æ—Å–Ω–∏–∫–∞: –≤–≤—ë–ª —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–∞–ª Enter ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
    survey_step = context.user_data.get("survey_step")
    if survey_step and 1 <= survey_step <= len(MEDICAL_QUESTIONS):
        if "survey_answers" not in context.user_data:
            context.user_data["survey_answers"] = {}
        answer_val = user_text[:500]
        context.user_data["survey_answers"][f"q{survey_step}"] = answer_val
        sheet_row = context.user_data.get("survey_sheet_row")
        if sheet_row is not None:
            await asyncio.to_thread(_sheet_update_answer, sheet_row, survey_step, answer_val)
        chat_id = update.effective_chat.id
        bot = context.bot
        msg_id = context.user_data.get("survey_question_message_id")
        if msg_id:
            try:
                await bot.delete_message(chat_id=chat_id, message_id=msg_id)
            except Exception:
                pass
        next_step = survey_step + 1
        total = len(MEDICAL_QUESTIONS)
        if next_step <= total:
            context.user_data["survey_step"] = next_step
            sent = await _send_survey_question(bot, chat_id, next_step, total)
            context.user_data["survey_question_message_id"] = sent.message_id
        else:
            user_id_sheet = context.user_data.pop("survey_sheet_id", None)
            saved_answers = dict(context.user_data.get("survey_answers") or {})
            context.user_data.pop("survey_step", None)
            context.user_data.pop("survey_answers", None)
            context.user_data.pop("survey_question_message_id", None)
            context.user_data.pop("survey_sheet_row", None)
            context.user_data["completed_survey_answers"] = saved_answers
            context.user_data["awaiting_request"] = True
            await bot.send_message(
                chat_id,
                _survey_done_message(user_id_sheet),
                parse_mode="HTML",
                reply_markup=MAIN_KEYBOARD,
            )
        return

    # –ö–Ω–æ–ø–∫–∏: –°—Ç–∞—Ä—Ç, –°—Ç–æ–ø, –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å, –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ, –î–∏–∞–≥–Ω–æ–∑, –õ–µ—á–µ–Ω–∏–µ
    if user_text == "–°—Ç–∞—Ä—Ç":
        await start(update, context)
        return
    if user_text == "–°—Ç–æ–ø":
        if context.job_queue:
            job_name = f"process_pending_{user_id}"
            for job in context.job_queue.jobs():
                if job.name == job_name:
                    job.schedule_removal()
                    break
        task = _pending_tasks.pop(user_id, None)
        if task and not task.done():
            task.cancel()
        _pending.pop(user_id, None)
        await update.message.reply_text("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –ë—É—Ñ–µ—Ä —Ñ–æ—Ç–æ –æ—á–∏—â–µ–Ω.", reply_markup=MAIN_KEYBOARD)
        return
    if user_text == "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å":
        if context.job_queue:
            job_name = f"process_pending_{user_id}"
            for job in context.job_queue.jobs():
                if job.name == job_name:
                    job.schedule_removal()
                    break
        task = _pending_tasks.pop(user_id, None)
        if task and not task.done():
            task.cancel()
        _pending.pop(user_id, None)
        await update.message.reply_text(
            "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫. –ë—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω. –ú–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ: –ø—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–∂–º–∏ ¬´–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ¬ª.",
            reply_markup=MAIN_KEYBOARD,
        )
        return
    if user_text == "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ":
        await update.message.reply_text(
            "–ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª —Å –∞–Ω–∞–ª–∏–∑–æ–º/–∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º. –ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî —á–µ—Ä–µ–∑ 10 —Å–µ–∫ —Ä–∞–∑–±–µ—Ä—É –≤–º–µ—Å—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ ¬´–≤—Å—ë¬ª / ¬´–≥–æ—Ç–æ–≤–æ¬ª.",
            reply_markup=MAIN_KEYBOARD,
        )
        return
    if user_text == "–î–∏–∞–≥–Ω–æ–∑":
        last = _user_last.get(user_id, {})
        diagnosis = (last.get("diagnosis") or "").strip()
        if diagnosis:
            await update.message.reply_text(diagnosis, reply_markup=MAIN_KEYBOARD)
        else:
            await update.message.reply_text("–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –∞–Ω–∞–ª–∏–∑–æ–≤/–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Äî —Ä–∞–∑–±–µ—Ä—É –∏ —Å–æ—Ö—Ä–∞–Ω—é.", reply_markup=MAIN_KEYBOARD)
        return
    if user_text == "–õ–µ—á–µ–Ω–∏–µ":
        last = _user_last.get(user_id, {})
        treatment = (last.get("treatment") or last.get("diagnosis") or "").strip()
        if treatment:
            await update.message.reply_text(treatment, reply_markup=MAIN_KEYBOARD)
        else:
            await update.message.reply_text("–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ª–µ—á–µ–Ω–∏—é. –ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ ‚Äî –ø–æ—Å–ª–µ —Ä–∞–∑–±–æ—Ä–∞ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.", reply_markup=MAIN_KEYBOARD)
        return

    # ¬´–í—Å—ë¬ª / ¬´–≥–æ—Ç–æ–≤–æ¬ª ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –ò–ò –∏ –∂–¥–∞—Ç—å –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ (–∏–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
    if user_text.lower() in ("–≤—Å—ë", "–≥–æ—Ç–æ–≤–æ", "–≤—Å–µ", "–≥–æ—Ç–æ–≤–æ."):
        if user_id in _pending and _pending[user_id]["file_ids"]:
            if context.job_queue:
                job_name = f"process_pending_{user_id}"
                for job in context.job_queue.jobs():
                    if job.name == job_name:
                        job.schedule_removal()
                        break
            task = _pending_tasks.pop(user_id, None)
            if task and not task.done():
                task.cancel()
            keyboard = _ai_choice_keyboard()
            if keyboard:
                await update.message.reply_text(
                    "–ì–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É. –í—ã–±–µ—Ä–∏—Ç–µ –ò–ò:",
                    reply_markup=keyboard,
                )
            else:
                await _process_pending_images(context, user_id)
            return
        # –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏–º, —á—Ç–æ –Ω–µ—á–µ–≥–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å
        await update.message.reply_text("–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞. –ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª—ã –∞–Ω–∞–ª–∏–∑–æ–≤/–∑–∞–∫–ª—é—á–µ–Ω–∏–π.", reply_markup=MAIN_KEYBOARD)
        return

    # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –ò–ò —Ç–µ–∫—Å—Ç, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ –§–ò–û (–∏–º—è —á–µ–ª–æ–≤–µ–∫–∞) ‚Äî –±–æ—Ç –Ω–µ –∏—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª—é–¥—è—Ö
    words = user_text.split()
    if (
        len(user_text) < 100
        and "?" not in user_text
        and 2 <= len(words) <= 5
        and all((w.replace("-", "").replace(".", "").isalpha()) for w in words)
    ):
        await update.message.reply_text(
            "–ü–æ—Ö–æ–∂–µ –Ω–∞ –§–ò–û. –Ø –Ω–µ –∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª—é–¥—è—Ö –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.\n\n"
            "–ï—Å–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –æ–ø—Ä–æ—Å ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ –∏ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ—Ä—è–¥–∫—É.\n"
            "–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –ø–æ –∑–¥–æ—Ä–æ–≤—å—é ‚Äî –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–≤–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: —á—Ç–æ –∑–Ω–∞—á–∏—Ç –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å–∞—Ö–∞—Ä?).",
            reply_markup=MAIN_KEYBOARD,
        )
        return

    has_groq = _use_groq()
    has_openai = bool(get_openai_client())
    if not has_groq and not has_openai:
        await update.message.reply_text(_no_ai_message())
        return

    await update.message.reply_text("–î—É–º–∞—é‚Ä¶")

    text = ""
    last_err = None
    if has_groq:
        try:
            text = await _ask_groq_text(user_text)
        except Exception as e:
            last_err = e
            logger.warning("Groq –ø—Ä–∏ —Ç–µ–∫—Å—Ç–µ: %s", e)
    if not text and has_openai:
        try:
            text = await _ask_openai_text(user_text)
        except Exception as e:
            last_err = e
            logger.warning("OpenAI –ø—Ä–∏ —Ç–µ–∫—Å—Ç–µ: %s", e)

    if not text:
        msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. "
        if last_err:
            msg += _short_error(last_err)
        else:
            msg += "–ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á–∏ –≤ .env (Groq –∏–ª–∏ OpenAI)."
        await update.message.reply_text(msg, reply_markup=MAIN_KEYBOARD)
        return
    if len(text) > 4000:
        text = text[:3997] + "..."
    await update.message.reply_text(text, reply_markup=MAIN_KEYBOARD)


async def _handle_patient_request(update: Update, context: ContextTypes.DEFAULT_TYPE, text: str) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞: –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏–ª–∏ follow-up –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞."""
    context.user_data["awaiting_request"] = False
    context.user_data["patient_request"] = text[:2000]

    survey_answers = context.user_data.get("completed_survey_answers") or {}
    survey_data = _format_survey_data(survey_answers)
    previous_analysis = context.user_data.get("full_analysis", "")

    if previous_analysis:
        await update.message.reply_text("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –≤–æ–ø—Ä–æ—Å —Å —É—á—ë—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö‚Ä¶")
        prompt = FOLLOWUP_PROMPT.format(
            survey_data=survey_data,
            previous_analysis=previous_analysis[:3000],
            followup_question=text,
        )
        ai_response = await _ask_ai_text(prompt, text)
        if not ai_response:
            ai_response = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å."

        ai_response = _strip_latex(ai_response)

        context.user_data["collecting_docs"] = True
        user_id = update.effective_user.id
        _pending.pop(user_id, None)

        send_docs_kb = InlineKeyboardMarkup([
            [InlineKeyboardButton("üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã", callback_data=CB_SEND_DOCS)],
        ])
        await update.message.reply_text(ai_response, reply_markup=MAIN_KEYBOARD)

        continue_kb = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data=CB_CONTINUE_YES),
                InlineKeyboardButton("üèÅ –ó–∞–∫–æ–Ω—á–∏—Ç—å", callback_data=CB_CONTINUE_NO),
            ],
        ])
        await update.message.reply_text(
            "–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ "
            "–∏–ª–∏ –∑–∞–¥–∞—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å.\n\n–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
            reply_markup=continue_kb,
        )
        return

    # –ü–µ—Ä–≤–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å: –ò–ò –∑–∞–¥–∞—ë—Ç 1‚Äì5 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    await update.message.reply_text("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –∑–∞–ø—Ä–æ—Å‚Ä¶")
    clarify_prompt = CLARIFY_QUESTIONS_PROMPT.format(
        survey_data=survey_data,
        patient_request=text[:1500],
    )
    questions_raw = await _ask_ai_text(clarify_prompt, text[:500])
    questions_list = _parse_questions_from_ai(questions_raw) if questions_raw else []

    if questions_list:
        context.user_data["ai_followup_questions"] = questions_list
        context.user_data["awaiting_followup_answers"] = True
        questions_text = "\n".join(f"‚Ä¢ {q}" for q in questions_list)
        await update.message.reply_text(
            "–ß—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é –∏ –¥–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Ç–≤–µ—Ç—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤:\n\n"
            f"{questions_text}\n\n"
            "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–º–æ–∂–Ω–æ –ø–æ –ø–æ—Ä—è–¥–∫—É –∏–ª–∏ –∫—Ä–∞—Ç–∫–æ).",
            parse_mode="HTML",
            reply_markup=MAIN_KEYBOARD,
        )
        return

    # –ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ò–ò –Ω–µ –≤–µ—Ä–Ω—É–ª ‚Äî —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
    await _finish_patient_request_with_docs(update, context, survey_data, text, followup_answers="")


async def _finish_patient_request_with_docs(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
    survey_data: str,
    patient_request: str,
    followup_answers: str,
) -> None:
    """–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–∏–ª–∏ –±–µ–∑ –Ω–∏—Ö): –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞, —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∫–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏."""
    followup_qa = ""
    if followup_answers and followup_answers.strip():
        followup_qa = "\n\n–û–¢–í–ï–¢–´ –ü–ê–¶–ò–ï–ù–¢–ê –ù–ê –£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´:\n" + followup_answers.strip()[:2000]

    prompt = REQUEST_ANALYSIS_PROMPT.format(
        survey_data=survey_data,
        patient_request=patient_request,
        followup_qa=followup_qa,
    )
    await update.message.reply_text("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –∑–∞–ø—Ä–æ—Å‚Ä¶")
    ai_response = await _ask_ai_text(prompt, patient_request[:500])
    if not ai_response:
        ai_response = (
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–º–µ—é—â–∏–µ—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:\n\n"
            "üìã –ê–Ω–∞–ª–∏–∑—ã\nüìã –í—ã–ø–∏—Å–Ω–æ–π —ç–ø–∏–∫—Ä–∏–∑\nüìã –ó–∞–∫–ª—é—á–µ–Ω–∏—è –≤—Ä–∞—á–µ–π\n"
            "üìã –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ä–µ—Ü–µ–ø—Ç—ã\nüìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π"
        )

    context.user_data["collecting_docs"] = True
    user_id = update.effective_user.id
    _pending.pop(user_id, None)

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìé –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑", callback_data=CB_SEND_DOCS)],
    ])
    await update.message.reply_text(
        f"{ai_response}\n\n"
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (—Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª—ã). –ö–æ–≥–¥–∞ –≤—Å—ë –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
        reply_markup=keyboard,
    )


async def handle_voice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç."""
    voice = update.message.voice
    if not voice:
        return
    try:
        tg_file = await context.bot.get_file(voice.file_id)
        buf = io.BytesIO()
        await tg_file.download_to_memory(buf)
        buf.seek(0)
        voice_bytes = buf.read()
    except Exception as e:
        logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ: %s", e)
        await update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        return

    await update.message.reply_text("–†–∞—Å–ø–æ–∑–Ω–∞—é –≥–æ–ª–æ—Å‚Ä¶")
    text = await asyncio.to_thread(_transcribe_voice_sync, voice_bytes)
    if not text:
        await update.message.reply_text(
            "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º."
        )
        return
    await update.message.reply_text(f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: <i>{_escape_html(text[:500])}</i>", parse_mode="HTML")

    if context.user_data.get("awaiting_request"):
        await _handle_patient_request(update, context, text)
        return

    if context.user_data.get("awaiting_followup_answers"):
        context.user_data["awaiting_followup_answers"] = False
        context.user_data.pop("ai_followup_questions", None)
        patient_request = context.user_data.get("patient_request", "")
        survey_answers = context.user_data.get("completed_survey_answers") or {}
        survey_data = _format_survey_data(survey_answers)
        await _finish_patient_request_with_docs(
            update, context, survey_data, patient_request, followup_answers=text
        )
        return

    if context.user_data.get("awaiting_post_doc_answers"):
        context.user_data["awaiting_post_doc_answers"] = False
        post_doc_questions = context.user_data.pop("post_doc_followup_questions", [])
        full_analysis = context.user_data.get("full_analysis", "")
        if full_analysis:
            qa_block = "–û—Ç–≤–µ—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞ –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:\n" + text[:2000]
            refine_prompt = REFINED_ANALYSIS_PROMPT.format(
                full_analysis=full_analysis[:6000],
                qa_block=qa_block,
            )
            await update.message.reply_text("–£—Ç–æ—á–Ω—è—é –∑–∞–∫–ª—é—á–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤‚Ä¶")
            refined = await _ask_ai_text(refine_prompt, qa_block)
            if refined:
                refined = _strip_latex(refined)
                context.user_data["full_analysis"] = refined
                _save_conclusion(update.effective_user.id, refined)
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("üìÑ –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data=CB_SHOW_RESULTS)],
            ])
            await update.message.reply_text(
                "–ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ.",
                reply_markup=keyboard,
            )
        return

    # –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∑–∞–ø—Ä–æ—Å–∞ ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
    has_groq = _use_groq()
    has_openai = bool(get_openai_client())
    if not has_groq and not has_openai:
        await update.message.reply_text(_no_ai_message())
        return
    await update.message.reply_text("–î—É–º–∞—é‚Ä¶")
    response = await _ask_ai_text(TEXT_PROMPT, text)
    if response:
        if len(response) > 4000:
            response = response[:3997] + "..."
        await update.message.reply_text(response, reply_markup=MAIN_KEYBOARD)
    else:
        await update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.", reply_markup=MAIN_KEYBOARD)


def _transcribe_voice_sync(voice_bytes: bytes) -> str:
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ asyncio.to_thread)."""
    buf = io.BytesIO(voice_bytes)
    buf.name = "voice.ogg"
    client = get_groq_client()
    if client:
        try:
            result = client.audio.transcriptions.create(model="whisper-large-v3", file=buf)
            return (result.text or "").strip()
        except Exception as e:
            logger.warning("Groq Whisper: %s", e)
    buf.seek(0)
    client = get_openai_client()
    if client:
        try:
            result = client.audio.transcriptions.create(model="whisper-1", file=buf)
            return (result.text or "").strip()
        except Exception as e:
            logger.warning("OpenAI Whisper: %s", e)
    return ""


async def handle_send_docs(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–Ω–æ–ø–∫–∞ '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑' ‚Äî –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑."""
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id if query.from_user else 0
    chat_id = query.message.chat_id
    bot = context.bot

    context.user_data["collecting_docs"] = False
    patient_request = context.user_data.get("patient_request", "")
    survey_answers = context.user_data.get("completed_survey_answers") or {}
    survey_data = _format_survey_data(survey_answers)

    data = _pending.pop(user_id, None)
    file_ids = data["file_ids"] if data else []

    if not file_ids:
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üìé –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑", callback_data=CB_SEND_DOCS)],
        ])
        try:
            await query.edit_message_text(
                "–í—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ —Ñ–∞–π–ª—ã –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–Ω–æ–≤–∞.",
                reply_markup=keyboard,
            )
        except Exception:
            pass
        if data:
            _pending[user_id] = data
        return

    try:
        await query.edit_message_text("–ó–∞–ø—É—Å–∫–∞—é –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑‚Ä¶")
    except Exception:
        pass

    images_b64: List[tuple] = []
    for file_id, mime in file_ids:
        try:
            tg_file = await bot.get_file(file_id)
            buf = io.BytesIO()
            await tg_file.download_to_memory(buf)
            buf.seek(0)
            images_b64.append((base64.b64encode(buf.read()).decode("utf-8"), mime))
        except Exception as e:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª %s: %s", file_id, e)

    if not images_b64:
        await bot.send_message(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞.")
        return

    progress_msg = await bot.send_message(
        chat_id, f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ‚Ä¶\n\n{_progress_bar(0)}"
    )
    stop_event = asyncio.Event()
    progress_task = asyncio.create_task(
        _progress_updater(bot, chat_id, progress_msg.message_id, stop_event)
    )

    prompt = FULL_ANALYSIS_PROMPT.format(survey_data=survey_data, patient_request=patient_request)
    user_msg = (
        f"–ó–∞–ø—Ä–æ—Å –ø–∞—Ü–∏–µ–Ω—Ç–∞: {patient_request}\n\n"
        "–ü—Ä–∏–ª–æ–∂–µ–Ω—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ü—Ä–æ–≤–µ–¥–∏ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."
    )
    try:
        analysis = await _ask_ai_with_images(prompt, user_msg, images_b64)
    finally:
        stop_event.set()
        progress_task.cancel()
        try:
            await progress_task
        except asyncio.CancelledError:
            pass
        try:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=progress_msg.message_id,
                text=f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ‚Ä¶\n\n{_progress_bar(100)}",
            )
        except Exception:
            pass
        await asyncio.sleep(0.3)
        try:
            await bot.delete_message(chat_id=chat_id, message_id=progress_msg.message_id)
        except Exception:
            pass

    if not analysis:
        await bot.send_message(
            chat_id,
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –¥—Ä—É–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.",
            reply_markup=MAIN_KEYBOARD,
        )
        return

    context.user_data["full_analysis"] = analysis
    _save_conclusion(user_id, analysis)

    # –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
    analysis_summary = (analysis[:1500] + "‚Ä¶") if len(analysis) > 1500 else analysis
    post_doc_prompt = POST_DOC_QUESTIONS_PROMPT.format(
        patient_request=patient_request or "–ù–µ —É–∫–∞–∑–∞–Ω",
        analysis_summary=analysis_summary,
    )
    questions_raw = await _ask_ai_text(post_doc_prompt, analysis_summary[:500])
    post_doc_questions = _parse_questions_from_ai(questions_raw) if questions_raw else []

    if post_doc_questions:
        context.user_data["post_doc_followup_questions"] = post_doc_questions
        context.user_data["awaiting_post_doc_answers"] = True
        questions_text = "\n".join(f"‚Ä¢ {q}" for q in post_doc_questions)
        await bot.send_message(
            chat_id,
            "<b>‚úÖ –ê–ù–ê–õ–ò–ó –í–´–ü–û–õ–ù–ï–ù</b>\n\n"
            "–ß—Ç–æ–±—ã —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Ç–≤–µ—Ç—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤:\n\n"
            f"{questions_text}\n\n"
            "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–º–æ–∂–Ω–æ –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º).",
            parse_mode="HTML",
            reply_markup=MAIN_KEYBOARD,
        )
    else:
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üìÑ –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", callback_data=CB_SHOW_RESULTS)],
        ])
        await bot.send_message(
            chat_id,
            "<b>‚úÖ –ê–ù–ê–õ–ò–ó –í–´–ü–û–õ–ù–ï–ù</b>\n\n–Ø –≥–æ—Ç–æ–≤ –≤—ã–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ —ç–∫—Ä–∞–Ω.",
            parse_mode="HTML",
            reply_markup=keyboard,
        )


async def handle_show_results(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ö–Ω–æ–ø–∫–∞ '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã' ‚Äî –≤—ã–≤–æ–¥ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."""
    query = update.callback_query
    await query.answer()
    chat_id = query.message.chat_id
    bot = context.bot

    analysis = context.user_data.get("full_analysis", "")
    if not analysis:
        await bot.send_message(chat_id, "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.", reply_markup=MAIN_KEYBOARD)
        return

    try:
        await query.message.delete()
    except Exception:
        pass

    if len(analysis) > 4000:
        analysis = analysis[:3997] + "..."
    formatted = _format_conclusion_for_elderly(analysis)
    await bot.send_message(
        chat_id,
        formatted,
        parse_mode="HTML",
        reply_markup=MAIN_KEYBOARD,
    )

    continue_kb = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data=CB_CONTINUE_YES),
            InlineKeyboardButton("‚ùå –ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ", callback_data=CB_CONTINUE_NO),
        ],
    ])
    await bot.send_message(
        chat_id,
        "–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
        reply_markup=continue_kb,
    )


async def handle_continue(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ '–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å' / '–ù–µ—Ç, —Å–ø–∞—Å–∏–±–æ' –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞."""
    query = update.callback_query
    await query.answer()
    data = (query.data or "").strip()
    chat_id = query.message.chat_id
    bot = context.bot

    try:
        await query.message.delete()
    except Exception:
        pass

    if data == CB_CONTINUE_YES:
        context.user_data["collecting_docs"] = True
        context.user_data["awaiting_request"] = True
        await bot.send_message(
            chat_id,
            "–û—Ç–ª–∏—á–Ω–æ! –í—ã –º–æ–∂–µ—Ç–µ:\n\n"
            "  ‚Äî –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º\n"
            "  ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–ª–∏ —Ñ–æ—Ç–æ\n\n"
            "–Ø –æ—Ç–≤–µ—á—É –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏ —É—á—Ç—É –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∞–Ω–∞–ª–∏–∑–µ.",
            reply_markup=MAIN_KEYBOARD,
        )
    elif data == CB_CONTINUE_NO:
        context.user_data.pop("full_analysis", None)
        context.user_data.pop("collecting_docs", None)
        context.user_data.pop("awaiting_request", None)
        context.user_data.pop("completed_survey_answers", None)
        context.user_data.pop("patient_request_text", None)
        await bot.send_message(
            chat_id,
            "–ë–ª–∞–≥–æ–¥–∞—Ä—é –≤–∞—Å –∑–∞ –¥–æ–≤–µ—Ä–∏–µ! –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è –∏ –±—É–¥—å—Ç–µ –∑–¥–æ—Ä–æ–≤—ã. üôè\n\n"
            "–ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å ‚Äî —è –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º. "
            "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ /start, –∏ –º—ã –Ω–∞—á–Ω—ë–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤ –ª—é–±–æ–µ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –≤–∞—Å –≤—Ä–µ–º—è.",
            reply_markup=MAIN_KEYBOARD,
        )


async def handle_contact(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–µ–ª–∏–ª—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É."""
    contact = update.message.contact
    if not contact or not contact.phone_number:
        return
    phone = contact.phone_number
    context.user_data["tg_phone"] = phone
    sheet_row = context.user_data.get("survey_sheet_row")
    if sheet_row:
        await asyncio.to_thread(
            lambda: _sheet_update_phone(sheet_row, phone)
        )
    await update.message.reply_text(
        f"–°–ø–∞—Å–∏–±–æ! –ù–æ–º–µ—Ä {phone} —Å–æ—Ö—Ä–∞–Ω—ë–Ω.",
        reply_markup=MAIN_KEYBOARD,
    )


def _sheet_update_phone(row_index: int, phone: str) -> Optional[str]:
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Å—Ç–æ–ª–±–µ—Ü D (—Ç–µ–ª–µ—Ñ–æ–Ω)."""
    try:
        wks, err = _get_sheet_wks()
        if wks is None:
            return err
        wks.update_cell(row_index, 4, phone)
        return None
    except Exception as e:
        _sheet_cache["wks"] = None
        return str(e)[:200]


def main() -> None:
    token = os.getenv("BOT_TOKEN")
    if not token:
        raise ValueError("–ó–∞–¥–∞–π BOT_TOKEN –≤ .env –∏–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

    app = Application.builder().token(token).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CallbackQueryHandler(handle_auth_choice, pattern="^auth:"))
    app.add_handler(CallbackQueryHandler(handle_flow_start, pattern="^flow:"))
    app.add_handler(CallbackQueryHandler(handle_consent, pattern="^consent:"))
    app.add_handler(CallbackQueryHandler(handle_ai_choice, pattern="^ai:"))
    app.add_handler(CallbackQueryHandler(handle_next_step, pattern="^next:"))
    app.add_handler(CallbackQueryHandler(handle_survey_callback, pattern="^survey:"))
    app.add_handler(CallbackQueryHandler(handle_send_docs, pattern="^docs:"))
    app.add_handler(CallbackQueryHandler(handle_show_results, pattern="^results:"))
    app.add_handler(CallbackQueryHandler(handle_continue, pattern="^continue:"))
    app.add_handler(MessageHandler(filters.CONTACT, handle_contact))
    app.add_handler(MessageHandler(filters.VOICE, handle_voice))
    app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (–æ–ø—Ä–æ—Å–Ω–∏–∫: %d –≤–æ–ø—Ä–æ—Å–æ–≤)", len(MEDICAL_QUESTIONS))
    app.run_polling(allowed_updates=Update.ALL_TYPES, drop_pending_updates=True)


if __name__ == "__main__":
    main()
